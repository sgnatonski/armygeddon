"use strict";function load(e){if(!e)return Promise.reject();if("string"==typeof e){var t=e;(e=new Image).src=t}else{if(void 0!==e.length){var n=[].map.call(e,function(e){return load(e).catch(function(e){return e})});return Promise.all(n).then(function(e){var t=e.filter(function(e){return e.naturalWidth});return t.length===e.length?t:Promise.reject({loaded:t,errored:e.filter(function(e){return!e.naturalWidth})})})}if("IMG"!==e.tagName)return Promise.reject()}var r=new Promise(function(t,n){e.naturalWidth?t(e):e.complete?n(e):(e.addEventListener("load",r),e.addEventListener("error",r));function r(){e.naturalWidth?t(e):n(e),e.removeEventListener("load",r),e.removeEventListener("error",r)}});return r.image=e,r}module.exports=load;var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();function JL(e){if(!e)return JL.__;Array.prototype.reduce||(Array.prototype.reduce=function(e,t){for(var n=t,r=0;r<this.length;r++)n=e(n,this[r],r,this);return n});var t="";return("."+e).split(".").reduce(function(e,n,r,i){t?t+="."+n:t=n;var o=e["__"+t];return void 0===o&&(JL.Logger.prototype=e,o=new JL.Logger(t),e["__"+t]=o),o},JL.__)}!function(e){e.requestId="",e.entryId=0,e._createXMLHttpRequest=function(){return new XMLHttpRequest},e._getTime=function(){return(new Date).getTime()},e._console=console;function t(e,t,n){void 0!==t[e]&&(null!==t[e]?n[e]=t[e]:delete n[e])}function n(t){if(null!=e.enabled&&!e.enabled)return!1;try{if(t.userAgentRegex&&!new RegExp(t.userAgentRegex).test(navigator.userAgent))return!1}catch(e){}try{if(t.ipRegex&&e.clientIP&&!new RegExp(t.ipRegex).test(e.clientIP))return!1}catch(e){}return!0}function r(e,t){try{if(e.disallow&&new RegExp(e.disallow).test(t))return!1}catch(e){}return!0}function i(e){return"function"==typeof e?e instanceof RegExp?e.toString():e():e}var o=function(){return function(e,t,n){this.msg=e,this.meta=t,this.finalString=n}}();function s(t){var n,r=i(t);switch(typeof r){case"string":return new o(r,null,r);case"number":case"boolean":return n=r.toString(),new o(n,null,n);case"undefined":return new o("undefined",null,"undefined");case"object":return r instanceof RegExp||r instanceof String||r instanceof Number||r instanceof Boolean?(n=r.toString(),new o(n,null,n)):(n="function"==typeof e.serialize?e.serialize.call(this,r):JSON.stringify(r),new o("",r,n));default:return new o("unknown",null,"unknown")}}e.setOptions=function(e){return t("enabled",e,this),t("maxMessages",e,this),t("defaultAjaxUrl",e,this),t("clientIP",e,this),t("requestId",e,this),t("defaultBeforeSend",e,this),t("serialize",e,this),this};e.getAllLevel=function(){return-2147483648};function u(){return 1e3}e.getTraceLevel=u;function a(){return 2e3}e.getDebugLevel=a;function h(){return 3e3}e.getInfoLevel=h;function f(){return 4e3}e.getWarnLevel=f;function c(){return 5e3}e.getErrorLevel=c;function l(){return 6e3}e.getFatalLevel=l;e.getOffLevel=function(){return 2147483647};var g=function(){return function(e,t){this.inner=t,this.name="JL.Exception",this.message=s(e).finalString}}();e.Exception=g,g.prototype=new Error;var d=function(){return function(e,t,n,r,i){this.l=e,this.m=t,this.n=n,this.t=r,this.u=i}}();e.LogItem=d;function p(t,n,r){return e.entryId++,new d(t,n,r,e._getTime(),e.entryId)}function m(e){e.id&&(clearTimeout(e.id),e.id=null)}function b(e,t,n){var r=this;e.id||(e.id=setTimeout(function(){n.call(r)},t))}var v=function(){function i(t,n){this.appenderName=t,this.sendLogItems=n,this.level=e.getTraceLevel(),this.sendWithBufferLevel=2147483647,this.storeInBufferLevel=-2147483648,this.bufferSize=0,this.batchSize=1,this.maxBatchSize=20,this.batchTimeout=2147483647,this.sendTimeout=5e3,this.buffer=[],this.batchBuffer=[],this.batchTimeoutTimer={id:null},this.sendTimeoutTimer={id:null},this.nbrLogItemsSkipped=0,this.nbrLogItemsBeingSent=0}return i.prototype.addLogItemsToBuffer=function(t){if(this.batchBuffer.length>=this.maxBatchSize)this.nbrLogItemsSkipped+=t.length;else{if(null!=e.maxMessages){if(e.maxMessages<1)return;e.maxMessages-=t.length}this.batchBuffer=this.batchBuffer.concat(t);var n=this;b(this.batchTimeoutTimer,this.batchTimeout,function(){n.sendBatch.call(n)})}},i.prototype.batchBufferHasOverdueMessages=function(){for(var t=0;t<this.batchBuffer.length;t++){if(e._getTime()-this.batchBuffer[t].t>this.batchTimeout)return!0}return!1},i.prototype.batchBufferHasStrandedMessage=function(){return!(null==e.maxMessages)&&e.maxMessages<1&&this.batchBuffer.length>0},i.prototype.sendBatchIfComplete=function(){(this.batchBuffer.length>=this.batchSize||this.batchBufferHasOverdueMessages()||this.batchBufferHasStrandedMessage())&&this.sendBatch()},i.prototype.onSendingEnded=function(){m(this.sendTimeoutTimer),this.nbrLogItemsBeingSent=0,this.sendBatchIfComplete()},i.prototype.setOptions=function(n){if(t("level",n,this),t("ipRegex",n,this),t("userAgentRegex",n,this),t("disallow",n,this),t("sendWithBufferLevel",n,this),t("storeInBufferLevel",n,this),t("bufferSize",n,this),t("batchSize",n,this),t("maxBatchSize",n,this),t("batchTimeout",n,this),t("sendTimeout",n,this),this.bufferSize<this.buffer.length&&(this.buffer.length=this.bufferSize),this.maxBatchSize<this.batchSize)throw new e.Exception({message:"maxBatchSize cannot be smaller than batchSize",maxBatchSize:this.maxBatchSize,batchSize:this.batchSize});return this},i.prototype.log=function(e,t,i,o,s,u,a){var h;n(this)&&r(this,u)&&(s<this.storeInBufferLevel||(h=p(s,u,a),s<this.level?this.bufferSize>0&&(this.buffer.push(h),this.buffer.length>this.bufferSize&&this.buffer.shift()):(this.addLogItemsToBuffer([h]),s>=this.sendWithBufferLevel&&this.buffer.length&&(this.addLogItemsToBuffer(this.buffer),this.buffer.length=0),this.sendBatchIfComplete())))},i.prototype.sendBatch=function(){if(!(this.nbrLogItemsBeingSent>0)&&(m(this.batchTimeoutTimer),0!=this.batchBuffer.length)){this.nbrLogItemsBeingSent=this.batchBuffer.length;var e=this;b(this.sendTimeoutTimer,this.sendTimeout,function(){e.onSendingEnded.call(e)}),this.sendLogItems(this.batchBuffer,function(){e.batchBuffer.splice(0,e.nbrLogItemsBeingSent),e.nbrLogItemsSkipped>0&&(e.batchBuffer.push(p(4e3,"Lost "+e.nbrLogItemsSkipped+" messages while connection with the server was down. Reduce lost messages by increasing the ajaxAppender option maxBatchSize.",e.appenderName)),e.nbrLogItemsSkipped=0),e.onSendingEnded.call(e)})}},i}();e.Appender=v;var y=function(n){__extends(r,n);function r(t){var i=n.call(this,t,r.prototype.sendLogItemsAjax)||this;return i.xhr=e._createXMLHttpRequest(),i}return r.prototype.setOptions=function(e){return t("url",e,this),t("beforeSend",e,this),n.prototype.setOptions.call(this,e),this},r.prototype.sendLogItemsAjax=function(t,n){try{var r=this.xhr.readyState;0!=r&&4!=r&&this.xhr.abort();var i="/jsnlog.logger";null!=e.defaultAjaxUrl&&(i=e.defaultAjaxUrl),this.url&&(i=this.url),this.xhr.open("POST",i),this.xhr.setRequestHeader("Content-Type","application/json"),this.xhr.setRequestHeader("JSNLog-RequestId",e.requestId);var o=this;this.xhr.onreadystatechange=function(){4==o.xhr.readyState&&o.xhr.status>=200&&o.xhr.status<300&&n()};var s={r:e.requestId,lg:t};"function"==typeof this.beforeSend?this.beforeSend.call(this,this.xhr,s):"function"==typeof e.defaultBeforeSend&&e.defaultBeforeSend.call(this,this.xhr,s);var u=JSON.stringify(s);this.xhr.send(u)}catch(e){}},r}(v);e.AjaxAppender=y;var x=function(t){__extends(n,t);function n(e){return t.call(this,e,n.prototype.sendLogItemsConsole)||this}return n.prototype.clog=function(t){e._console.log(t)},n.prototype.cerror=function(t){e._console.error?e._console.error(t):this.clog(t)},n.prototype.cwarn=function(t){e._console.warn?e._console.warn(t):this.clog(t)},n.prototype.cinfo=function(t){e._console.info?e._console.info(t):this.clog(t)},n.prototype.cdebug=function(t){e._console.debug?e._console.debug(t):this.cinfo(t)},n.prototype.sendLogItemsConsole=function(t,n){try{if(!e._console)return;var r;for(r=0;r<t.length;++r){var i=t[r],o=i.n+": "+i.m;"undefined"==typeof window&&(o=new Date(i.t)+" | "+o),i.l<=e.getDebugLevel()?this.cdebug(o):i.l<=e.getInfoLevel()?this.cinfo(o):i.l<=e.getWarnLevel()?this.cwarn(o):this.cerror(o)}}catch(e){}n()},n}(v);e.ConsoleAppender=x;var L=function(){function e(e){this.loggerName=e,this.seenRegexes=[]}return e.prototype.setOptions=function(e){return t("level",e,this),t("userAgentRegex",e,this),t("disallow",e,this),t("ipRegex",e,this),t("appenders",e,this),t("onceOnly",e,this),this.seenRegexes=[],this},e.prototype.buildExceptionObject=function(e){var t={};return e.stack?t.stack=e.stack:t.e=e,e.message&&(t.message=e.message),e.name&&(t.name=e.name),e.data&&(t.data=e.data),e.inner&&(t.inner=this.buildExceptionObject(e.inner)),t},e.prototype.log=function(e,t,o){var u,a,h=0;if(!this.appenders)return this;if(e>=this.level&&n(this)&&(o?(a=this.buildExceptionObject(o)).logData=i(t):a=t,r(this,(u=s(a)).finalString))){if(this.onceOnly)for(h=this.onceOnly.length-1;h>=0;){if(new RegExp(this.onceOnly[h]).test(u.finalString)){if(this.seenRegexes[h])return this;this.seenRegexes[h]=!0}h--}for(u.meta=u.meta||{},h=this.appenders.length-1;h>=0;)this.appenders[h].log((f=e)<=1e3?"trace":f<=2e3?"debug":f<=3e3?"info":f<=4e3?"warn":f<=5e3?"error":"fatal",u.msg,u.meta,function(){},e,u.finalString,this.loggerName),h--}var f;return this},e.prototype.trace=function(e){return this.log(1e3,e)},e.prototype.debug=function(e){return this.log(2e3,e)},e.prototype.info=function(e){return this.log(3e3,e)},e.prototype.warn=function(e){return this.log(4e3,e)},e.prototype.error=function(e){return this.log(5e3,e)},e.prototype.fatal=function(e){return this.log(6e3,e)},e.prototype.fatalException=function(e,t){return this.log(6e3,e,t)},e}();e.Logger=L;e.createAjaxAppender=function(e){return new y(e)};e.createConsoleAppender=function(e){return new x(e)};var w=new x("");"undefined"!=typeof window&&(w=new y("")),e.__=new e.Logger(""),e.__.setOptions({level:e.getDebugLevel(),appenders:[w]})}(JL||(JL={})),"undefined"!=typeof exports&&(exports.JL=JL);var define;"function"==typeof define&&define.amd&&define("jsnlog",[],function(){return JL}),"function"==typeof __jsnlog_configure&&__jsnlog_configure(JL),"undefined"==typeof window||window.onerror||(window.onerror=function(e,t,n,r,i){return JL("onerrorLogger").fatalException({msg:"Uncaught Exception",errorMsg:e,url:t,"line number":n,column:r},i),!1}),"undefined"==typeof window||window.onunhandledrejection||(window.onunhandledrejection=function(e){JL("onerrorLogger").fatalException({msg:"unhandledrejection",errorMsg:e.reason?e.reason.message:null},e.reason)});