function Animator(){var t,e,i=[];return{registerAnimation:(e,n,a)=>{i[e]=n,t=a},getAnimation:(n,a)=>e=getUnitMoveAnim(a,i[n],t).then(()=>e=null),isAnimating:()=>e}}function Damage(){var t=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],e=(e,i,n,a)=>{var r=n-e,s=a-i;return t.findIndex(t=>t.x==r&&t.y==s)+1};return{getRangeDamage:(t,i)=>{var n=t.damage+t.charge/2-i.armor,a=Math.max(...[Math.abs(t.pos.x-i.pos.x),Math.abs(t.pos.y-i.pos.y)]),r=e(i.pos.x,i.pos.y,t.pos.x,t.pos.y),s=i.directions.some(t=>t==r);(1==a||s)&&(a=2*t.range);return Math.floor(n*t.range/a)},getChargeDamage:(t,i)=>{var n=Math.pow(t.charge-1,2),a=e(t.pos.x,t.pos.y,i.pos.x,i.pos.y),r=e(i.pos.x,i.pos.y,t.pos.x,t.pos.y),s=t.directions.some(t=>t==a),o=i.directions.some(t=>t==r);s&&t.directions[0]==i.directions[0]&&(n*=2),(n<0||!s)&&(n=0);var l=o?i.armor:0;return t.damage+n-l}}}function EventBus(){var t={};return{on:(e,i)=>{t[e]||(t[e]=[]),t[e].push(i)},publish:(e,i)=>{t[e]&&t[e].forEach(t=>t(i))}}}function initGrid(t){function e(t,e){n.selectedHex;if(n.selectedHex=null,void 0!=t&&void 0!=e){var i=n.getHexAt(new BHex.Axial(t,e));n.selectedHex=i}}function i(e,i,a,r){var s=n.findPath(new BHex.Axial(e.x,e.y),new BHex.Axial(i.x,i.y),r),o=t.getTerrain();return s.filter(t=>o.find(e=>e.x==t.x&&e.y==t.y)).reduce((t,i)=>{var n=t.map(t=>t.cost).reduce((t,e)=>t+e,-e.cost);return(r||n+i.cost<=a)&&t.push(i),t},[e])}var n=new BHex.Grid(t.getSceneSize());return t.getUnits().forEach(t=>{n.getHexAt(new BHex.Axial(t.pos.x,t.pos.y)).blocked=!0}),t.getTerrain().forEach(t=>{n.getHexAt(new BHex.Axial(t.x,t.y)).cost=t.cost}),{getHexes:function(){return t.getTerrain().map(t=>n.hexes.find(e=>t.x==e.x&&t.y==e.y))},getSelectedHex:()=>n.selectedHex?n.getHexAt(new BHex.Axial(n.selectedHex.x,n.selectedHex.y)):null,getHexAt:(t,e)=>n.getHexAt(new BHex.Axial(t,e)),getUnitAt:(e,i)=>t.getUnitAt(e,i),getUnits:function(){return t.getUnits()},isPlayerArmy:(e,i)=>t.isPlayerArmy(e,i),hexSelected:function(a){var r=n.selectedHex;r&&(r.blocked=!1);var s=n.selectedHex?t.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;switch(t.getUnitState(s)){case"moving":(l=(o=i(r,a,s.mobility))[o.length-1]).x==a.x&&l.y==a.y&&t.unitMoving(s,a.x,a.y);break;case"turning":t.unitTurning(s,a.x,a.y);break;case"attacking":var o,l;(l=(o=i(r,a,s.range,!0))[o.length-1]).x==a.x&&l.y==a.y&&t.unitAttacking(s,a.x,a.y);break;default:if(s=t.nextUnit()){var h=n.getHexAt(new BHex.Axial(s.pos.x,s.pos.y));e(h.x,h.y)}}},getSelectedHexRange:function(){var e=n.selectedHex?t.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;if(e){var i=t.getUnitState(e),a=[];a="moving"==i?n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),e.mobility):"turning"==i?function(t){for(var e=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],i=t.directions[0],n=[e[i-1]],a=1;a<=t.agility;a++){var r=i-1-a;r<0&&(r=e.length+r);var s=i-1+a;s>e.length-1&&(s-=e.length),n.push(e[r]),n.push(e[s])}return n}(e).map(t=>n.getHexAt(new BHex.Axial(e.pos.x+t.x,e.pos.y+t.y))):n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),e.range,!0);var r=t.getTerrain();return a.filter(t=>r.find(e=>e.x==t.x&&e.y==t.y))}return[]},getSelectedHexState:function(){return t.getUnitState(n.selectedHex?t.getUnitAt(n.selectedHex.x,n.selectedHex.y):null)},getPathBetween:function(e,n){var a=t.getUnitAt(e.x,e.y);return a?i(e,n,a.mobility):[]},getSelectedHexMoveCost:(e,i)=>n.selectedHex?function(e,i,a){var r=n.findPath(new BHex.Axial(e.x,e.y),new BHex.Axial(i.x,i.y)),s=t.getTerrain();return(r.filter(t=>s.find(e=>e.x==t.x&&e.y==t.y))||[]).map(t=>t.cost).reduce((t,e)=>t+e,[])}(n.selectedHex,n.getHexAt(new BHex.Axial(e,i)),t.getUnitAt(n.selectedHex.x,n.selectedHex.y)):null,initDrawing:function(t){var e=new BHex.Drawing.Options(30,BHex.Drawing.Static.Orientation.PointyTop,new BHex.Drawing.Point(t.x,t.y));BHex.Drawing.Drawing(n,e)},updateSelection:function(i){n.getHexAt(new BHex.Axial(i.pos.x,i.pos.y)).blocked=!0;var a=t.nextUnit(),r=n.getHexAt(new BHex.Axial(a.pos.x,a.pos.y));return e(r.x,r.y),r}}}function setupStage(t,e,i){var n=window.innerWidth,a=window.innerHeight,r={x:n/2,y:a/2},s=new Konva.Stage({container:"container",width:n,height:a});window.addEventListener("resize",t=>{s.width(window.innerWidth),s.height(window.innerHeight)}),t.initDrawing(r);var o=new Animator,l=createEffectLayer(r),h=createUnitLayer(r,t,o),d=createHighlightLayer(r),u=createTerrainLayer(),g=createTooltipLayer(s),y=createWaitLayer(n,a);e.on("battlestarted",()=>{y.hide()}),e.on("battlestate",t=>{console.log(t)});var c=null;e.on("unitdelta",e=>{c=t.getPathBetween(t.getHexAt(e.source.x,e.source.y),t.getHexAt(e.target.x,e.target.y))}),e.on("battleupdated",e=>{o.getAnimation(e.currUnit.id,c).then(()=>{var i=t.updateSelection(e.currUnit);t.isPlayerArmy(e.nextUnit.id)&&(d.highlightNode(i),d.highlightRange(t.getSelectedHexRange(),t.getSelectedHexState())),h.refresh()})});u.addGridNodes(t,function(e){var n=createTerrainVisual(e,r,i);return n.on("click",()=>{d.highlightNode(null),l.drawPath([]),d.highlightRange([],t.getSelectedHexState()),t.hexSelected(e)}),n.on("mouseenter",()=>{if(!o.isAnimating()){var i=null,n=t.getSelectedHex();n&&(i=t.getUnitAt(n.x,n.y));var a=t.getUnitAt(e.x,e.y),r=t.getSelectedHexState();if(t.isPlayerArmy(i.id)&&(d.highlightNode(e),l.drawPath(t.getPathBetween(t.getSelectedHex(),e)),d.highlightRange(t.getSelectedHexRange(),r)),"moving"==r||"turning"==r){if(i&&a)g.updateTooltipWithUnitStats(a);else if(!a){var s=t.getSelectedHexMoveCost(e.x,e.y);g.updateTooltipWithMoveStats(i,s)}}else"attacking"==r&&i&&a&&g.updateTooltipWithAttackStats(i,a)}}),n.on("mouseleave",()=>{o.isAnimating()||(d.highlightNode(null),g.hideTooltip())}),{node:n,coord:createHexCoordVisual(e,r)}}),s.add(u),s.add(d),s.add(l),s.add(h.node),s.add(g.node),s.add(y.node),t.hexSelected();var x=t.getSelectedHex();if(x){var m=t.getUnitAt(x.x,x.y);t.isPlayerArmy(m.id)&&(d.highlightNode(x),d.highlightRange(t.getSelectedHexRange(),t.getSelectedHexState()))}}(Game=Game||{}).Army=function(t,e){this.playerId=t.id,this.playerName=t.name,this.unitTypes=e,this.units=Object.keys(t.units).map(e=>t.units[e])},Game.Army.prototype.getArmy=function(){return this.units},Game.Army.prototype.restoreUnit=function(t){var e=this.units.find(e=>e.id==t.id);Object.assign(e,t)};(Game=Game||{}).Battle=function(t){this.eventBus=t,this.eventBus.on("update",t=>this.onUpdate(t)),this.battleState="none"},Game.Battle.prototype.getSceneSize=function(){var t=this.terrain.map(t=>t.x),e=this.terrain.map(t=>t.y),i=Math.abs(Math.min(...t)),n=Math.abs(Math.max(...t)),a=Math.abs(Math.min(...e)),r=Math.abs(Math.max(...e));return Math.max(...[i,n,a,r])},Game.Battle.prototype.load=function(){var t=sessionStorage.getItem("singlebattleid"),e=`/singlebattle/join/${t||""}`;return Game.fetch().post(e).then(t=>(this.loadData(t,!0),Promise.resolve(this)))},Game.Battle.prototype.loadData=function(t,e){var i=Object.keys(t.armies).map(e=>t.armies[e]);sessionStorage.setItem(e?"singlebattleid":"battleid",t.id),this.id=t.id,this.selfArmy=t.selfArmy,this.terrain=t.terrain,this.unitQueue=t.turns[t.turns.length-1].readyUnits,this.firstArmy=new Game.Army(i[0],t.unitTypes),this.battleState="created";var n=this.getBattleStateText();if(setTimeout(()=>this.eventBus.publish("battlestate",n),0),2==i.length){this.secondArmy=new Game.Army(i[1],t.unitTypes),this.battleState="ready";var a=this.getBattleStateText();setTimeout(()=>this.eventBus.publish("battlestarted"),0),setTimeout(()=>this.eventBus.publish("battlestate",a),0);var r=this.nextUnit(),s=this.getArmy(r).playerName;setTimeout(()=>this.eventBus.publish("battlestate",`${s} ${r.type} unit is next to act`),0)}},Game.Battle.prototype.getTerrain=function(){return this.terrain},Game.Battle.prototype.getUnits=function(){return this.secondArmy?this.firstArmy.getArmy().concat(this.secondArmy.getArmy()):this.firstArmy.getArmy()},Game.Battle.prototype.nextUnit=function(){return this.getUnits().find(t=>t.id==this.unitQueue[0])},Game.Battle.prototype.getArmy=function(t){return this.firstArmy.getArmy().some(e=>e.id==t)?this.firstArmy:this.secondArmy},Game.Battle.prototype.getOtherArmy=function(t){return this.firstArmy.getArmy().some(e=>e.id==t)?this.secondArmy:this.firstArmy},Game.Battle.prototype.onUpdate=function(t){if(this.isDefeatedArmy(t.currUnit.id)&&(this.battleState="finished"),this.isWinningArmy(t.currUnit.id))this.battleState="finished";else{this.battleState="started",this.eventBus.publish("unitdelta",{source:this.nextUnit().pos,target:t.currUnit.pos}),this.unitQueue=t.unitQueue;if(this.getArmy(t.currUnit.id).restoreUnit(t.currUnit),t.targetUnit){this.getArmy(t.targetUnit.id).restoreUnit(t.targetUnit)}this.getArmy(t.nextUnit.id).restoreUnit(t.nextUnit),this.eventBus.publish("battleupdated",t)}this.eventBus.publish("battlestate",this.getBattleStateText());var e=this.nextUnit(),i=this.getArmy(e).playerName;setTimeout(()=>this.eventBus.publish("battlestate",`${i} ${e.type} unit is next to act`),0)},Game.Battle.prototype.unitMoving=function(t,e,i,n){requestMove(this.eventBus,this.id,t.id,e,i)},Game.Battle.prototype.unitTurning=function(t,e,i){requestTurn(this.eventBus,this.id,t.id,e,i)},Game.Battle.prototype.unitAttacking=function(t,e,i){requestAttack(this.eventBus,this.id,t.id,e,i)},Game.Battle.prototype.getUnitState=function(t){return t?t.endurance<=0?"dead":t.mobility>0?"moving":t.agility>0?"turning":t.attacks>0?"attacking":void 0:"none"},Game.Battle.prototype.getUnitAt=function(t,e){return this.getUnits().find(i=>i.pos.x==t&&i.pos.y==e)},Game.Battle.prototype.isWinningArmy=function(t){return!this.getOtherArmy(t).units.some(t=>t.endurance>0)},Game.Battle.prototype.isDefeatedArmy=function(t){return!this.getArmy(t).units.some(t=>t.endurance>0)},Game.Battle.prototype.isPlayerArmy=function(t,e){return e?this.selfArmy===this.getArmy(t).playerId:this.selfArmy===this.getArmy(t).playerId||"_"+this.selfArmy===this.getArmy(t).playerId||this.selfArmy==="_"+this.getArmy(t).playerId},Game.Battle.prototype.getBattleStateText=function(){return"none"==this.battleState?"":"created"==this.battleState?`Army of ${this.firstArmy.playerName} has arrived`:"ready"==this.battleState?`Army of ${this.secondArmy.playerName} has arrived`:"started"==this.battleState?`Army of ${this.firstArmy.playerName} is fighting with army of ${this.secondArmy.playerName}`:"finished"==this.battleState?this.firstArmy.units.some(t=>t.endurance>0)?`Army of ${this.firstArmy.playerName} has won`:`Army of ${this.secondArmy.playerName} has won`:void 0};var Game,defaultHeaders={"Content-Type":"application/json"},fetchOpts={get:{method:"GET",credentials:"include",defaultHeaders:defaultHeaders},post:{method:"POST",credentials:"include",defaultHeaders:defaultHeaders}};(Game=Game||{}).fetch=function(){return{get:t=>fetch(t,fetchOpts.get).then(t=>t.text()).then(t=>JSON.parse(t)),post:(t,e)=>{var i=e?Object.assign({},fetchOpts.post,{body:JSON.stringify(e),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"}}):fetchOpts.post;return fetch(t,i).then(t=>t.text()).then(t=>JSON.parse(t))}}};