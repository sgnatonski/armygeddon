function Animator(){var e,t,i=[];return{registerAnimation:(t,n,a)=>{i[t]=n,e=a},getAnimation:(n,a)=>t=getUnitMoveAnim(a,i[n],e).then(()=>t=null),isAnimating:()=>t}}function cullView(e,t,i){for(var n=-1*t.x()-e.clientWidth/2,a=-1*t.y()-e.clientHeight/2,r=2*e.clientWidth,s=2*e.clientHeight,o=0,l=0,h=i.children,d=0;d<h.length;d++)o=h[d].getX(),l=h[d].getY(),o>n&&o<n+r&&l>a&&l<a+s?h[d].visible()||h[d].show():h[d].hide()}function Damage(){var e=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],t=(t,i,n,a)=>{var r=n-t,s=a-i;return e.findIndex(e=>e.x==r&&e.y==s)+1};return{getRangeDamage:(e,i)=>{var n=e.damage+e.charge/2-i.armor,a=Math.max(...[Math.abs(e.pos.x-i.pos.x),Math.abs(e.pos.y-i.pos.y)]),r=t(i.pos.x,i.pos.y,e.pos.x,e.pos.y),s=i.directions.some(e=>e==r);(1==a||s)&&(a=2*e.range);return Math.floor(n*e.range/a)},getChargeDamage:(e,i)=>{var n=Math.pow(e.charge-1,2),a=t(e.pos.x,e.pos.y,i.pos.x,i.pos.y),r=t(i.pos.x,i.pos.y,e.pos.x,e.pos.y),s=e.directions.some(e=>e==a),o=i.directions.some(e=>e==r);s&&e.directions[0]==i.directions[0]&&(n*=2),(n<0||!s)&&(n=0);var l=o?i.armor:0;return e.damage+n-l}}}function EventBus(){var e={};return{on:(t,i)=>{e[t]||(e[t]=[]),e[t].push(i)},publish:(t,i)=>{e[t]&&e[t].forEach(e=>e(i))}}}function initGrid(e){function t(e,t){n.selectedHex;if(n.selectedHex=null,void 0!=e&&void 0!=t){var i=n.getHexAt(new BHex.Axial(e,t));n.selectedHex=i}}function i(t,i){var a=e.getUnitAt(t.x,t.y);if(a){var r,s;switch(e.getUnitState(a)){case"moving":r=a.mobility;break;case"attacking":r=a.range,s=!0}o=n.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(i.x,i.y),s),l=e.getTerrain();return(h=o.filter(e=>l.find(t=>t.x==e.x&&t.y==e.y))).reduce((e,i)=>{var n=e.map(e=>e.cost).reduce((e,t)=>e+t,-t.cost);return(s||n+i.cost<=r)&&e.push(i),e},[t])}var o=n.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(i.x,i.y),s),l=e.getTerrain(),h=o.filter(e=>l.find(t=>t.x==e.x&&t.y==e.y));return[t].concat(h)}var n=new BHex.Grid(e.getSceneSize());return e.getUnits().forEach(e=>{n.getHexAt(new BHex.Axial(e.pos.x,e.pos.y)).blocked=!0}),e.getTerrain().forEach(e=>{n.getHexAt(new BHex.Axial(e.x,e.y)).cost=e.cost}),{getHexes:function(){return e.getTerrain().map(e=>n.hexes.find(t=>e.x==t.x&&e.y==t.y))},getSelectedHex:()=>n.selectedHex?n.getHexAt(new BHex.Axial(n.selectedHex.x,n.selectedHex.y)):null,getHexAt:(e,t)=>n.getHexAt(new BHex.Axial(e,t)),getUnitAt:(t,i)=>e.getUnitAt(t,i),getUnits:function(){return e.getUnits()},isPlayerArmy:(t,i)=>e.isPlayerArmy(t,i),hexSelected:function(a){var r=n.selectedHex;r&&(r.blocked=!1);var s=n.selectedHex&&a?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;switch(e.getUnitState(s)){case"moving":(l=(o=i(r,a))[o.length-1]).x==a.x&&l.y==a.y&&e.unitMoving(s,a.x,a.y);break;case"turning":e.unitTurning(s,a.x,a.y);break;case"attacking":var o,l;(l=(o=i(r,a,s.range))[o.length-1]).x==a.x&&l.y==a.y&&e.unitAttacking(s,a.x,a.y);break;default:if(s=e.nextUnit()){var h=n.getHexAt(new BHex.Axial(s.pos.x,s.pos.y));t(h.x,h.y)}}},getSelectedHexRange:function(){var t=n.selectedHex?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;if(t){var i=e.getUnitState(t),a=[];a="moving"==i?n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),t.mobility):"turning"==i?function(e){for(var t=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],i=e.directions[0],n=[t[i-1]],a=1;a<=e.agility;a++){var r=i-1-a;r<0&&(r=t.length+r);var s=i-1+a;s>t.length-1&&(s-=t.length),n.push(t[r]),n.push(t[s])}return n}(t).map(e=>n.getHexAt(new BHex.Axial(t.pos.x+e.x,t.pos.y+e.y))):n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),t.range,!0);var r=e.getTerrain();return a.filter(e=>r.find(t=>t.x==e.x&&t.y==e.y))}return[]},getSelectedHexState:function(){return e.getUnitState(n.selectedHex?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null)},getPathBetween:function(e,t){return i(e,t)},getSelectedHexMoveCost:(t,i)=>n.selectedHex?function(t,i,a){var r=n.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(i.x,i.y)),s=e.getTerrain();return(r.filter(e=>s.find(t=>t.x==e.x&&t.y==e.y))||[]).map(e=>e.cost).reduce((e,t)=>e+t,[])}(n.selectedHex,n.getHexAt(new BHex.Axial(t,i)),e.getUnitAt(n.selectedHex.x,n.selectedHex.y)):null,initDrawing:function(e){var t=new BHex.Drawing.Options(30,BHex.Drawing.Static.Orientation.PointyTop,new BHex.Drawing.Point(e.x,e.y));BHex.Drawing.Drawing(n,t)},updateSelection:function(i){n.getHexAt(new BHex.Axial(i.pos.x,i.pos.y)).blocked=!0;var a=e.nextUnit(),r=n.getHexAt(new BHex.Axial(a.pos.x,a.pos.y));return t(r.x,r.y),r}}}function setupStage(e,t,i){var n=document.getElementById("container"),a=n.clientWidth,r=n.offsetTop,s={x:a/2,y:r/2},o=new Konva.Stage({container:"container",width:a,height:r});e.initDrawing(s);var l=new Animator,h=createTerrainLayer(),{minX:d,minY:g,maxX:c,maxY:u}=h.addGridNodes(e,function(t){var n=createTerrainVisual(t,s,i);return n.on("click dbltap",()=>{p.highlightNode(null),x.drawPath([]),p.highlightRange([],e.getSelectedHexState()),e.hexSelected(t)}),n.on("mouseenter",()=>{if(!l.isAnimating()){var i=null,n=e.getSelectedHex();n&&(i=e.getUnitAt(n.x,n.y));var a=e.getUnitAt(t.x,t.y),r=e.getSelectedHexState();if(e.isPlayerArmy(i.id)&&(p.highlightNode(t),x.drawPath(e.getPathBetween(e.getSelectedHex(),t)),p.highlightRange(e.getSelectedHexRange(),r)),"moving"==r||"turning"==r){if(i&&a)f.updateTooltipWithUnitStats(a);else if(!a){var s=e.getSelectedHexMoveCost(t.x,t.y);f.updateTooltipWithMoveStats(i,s)}}else"attacking"==r&&i&&a&&f.updateTooltipWithAttackStats(i,a)}}),n.on("mouseleave",()=>{l.isAnimating()||(p.highlightNode(null),f.hideTooltip())}),n.add(createHexCoordVisual(t,s)),n}),y=(Math.abs(d),Math.abs(c),Math.abs(g)+Math.abs(u)+160);n.style.minHeight=y+"px",o.setHeight(y),r=y,s.y=r/2,h.setY(s.y);var x=createEffectLayer(s),m=createUnitLayer(s,e,l),p=createHighlightLayer(s),f=createTooltipLayer(o),A=createWaitLayer(a,r);A.show("Sir,\nYou're first on the battlefield.\n\nHopefully the other army will arrive soon."),t.on("battlestarted",()=>{A.hide()}),t.on("battleended",t=>{p.highlightNode(null),x.drawPath([]),p.highlightRange([],e.getSelectedHexState()),e.hexSelected(),m.refresh(),f.hideTooltip(),A.show("Battle has ended")}),t.on("battlestate",e=>{console.log(e)}),t.on("battleupdated",t=>{var i=e.getPathBetween(e.getHexAt(t.delta.source.x,t.delta.source.y),e.getHexAt(t.delta.target.x,t.delta.target.y));l.getAnimation(t.data.currUnit.id,i).then(()=>{var i=e.updateSelection(t.data.currUnit);e.isPlayerArmy(t.data.nextUnit.id)&&(p.highlightNode(i),p.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState())),m.refresh()})});var v,H;o.on("touchstart",e=>{v=-o.getX()+e.evt.touches[0].clientX,H=-o.getY()+e.evt.touches[0].clientY}),o.on("touchmove",e=>{var t=-(v-e.evt.touches[0].clientX),i=-(H-e.evt.touches[0].clientY);o.setX(t),o.setY(i),cullView(n,o,h),o.batchDraw()});o.add(h),o.add(p),o.add(x),o.add(m.node),o.add(f.node),o.add(A.node),e.hexSelected();var S=e.getSelectedHex();if(S){var B=e.getUnitAt(S.x,S.y);e.isPlayerArmy(B.id)&&(p.highlightNode(S),p.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState())),Konva.pixelRatio=1}}(Game=Game||{}).Army=function(e,t){this.playerId=e.id,this.playerName=e.name,this.unitTypes=t,this.units=Object.keys(e.units).map(t=>e.units[t])},Game.Army.prototype.getArmy=function(){return this.units},Game.Army.prototype.restoreUnit=function(e){var t=this.units.find(t=>t.id==e.id);Object.assign(t,e)};(Game=Game||{}).Battle=function(e){this.eventBus=e,this.eventBus.on("update",e=>this.onUpdate(e)),this.eventBus.on("end",e=>this.onEnd(e)),this.battleState="none"},Game.Battle.prototype.getSceneSize=function(){return this.sceneSize},Game.Battle.prototype.load=function(){var e=sessionStorage.getItem("singlebattleid"),t=`/singlebattle/join/${e||""}`;return Game.fetch().post(t).then(e=>(this.loadData(e,!0),Promise.resolve(this)))},Game.Battle.prototype.loadData=function(e,t){var i=Object.keys(e.armies).map(t=>e.armies[t]);sessionStorage.setItem(t?"singlebattleid":"battleid",e.id),this.id=e.id,this.selfArmy=e.selfArmy,this.terrain=e.terrain,this.sceneSize=e.sceneSize,this.unitQueue=e.turns[e.turns.length-1].readyUnits,this.firstArmy=new Game.Army(i[0],e.unitTypes),this.battleState="created";var n=this.getBattleStateText();if(setTimeout(()=>this.eventBus.publish("battlestate",n),0),2==i.length){this.secondArmy=new Game.Army(i[1],e.unitTypes),this.battleState="ready";var a=this.getBattleStateText();setTimeout(()=>this.eventBus.publish("battlestarted"),0),setTimeout(()=>this.eventBus.publish("battlestate",a),0);var r=this.nextUnit(),s=this.getArmy(r).playerName;setTimeout(()=>this.eventBus.publish("battlestate",`${s} ${r.type} unit is next to act`),0)}},Game.Battle.prototype.getTerrain=function(){return this.terrain},Game.Battle.prototype.getUnits=function(){return this.secondArmy?this.firstArmy.getArmy().concat(this.secondArmy.getArmy()):this.firstArmy.getArmy()},Game.Battle.prototype.nextUnit=function(){return this.getUnits().find(e=>e.id==this.unitQueue[0])},Game.Battle.prototype.getArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.firstArmy:this.secondArmy},Game.Battle.prototype.getOtherArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.secondArmy:this.firstArmy},Game.Battle.prototype.onUpdate=function(e){this.battleState="started";var t={source:this.nextUnit().pos,target:e.currUnit.pos};this.unitQueue=e.unitQueue;if(this.getArmy(e.currUnit.id).restoreUnit(e.currUnit),e.targetUnit){this.getArmy(e.targetUnit.id).restoreUnit(e.targetUnit)}this.getArmy(e.nextUnit.id).restoreUnit(e.nextUnit),this.eventBus.publish("battleupdated",{delta:t,data:e}),this.eventBus.publish("battlestate",this.getBattleStateText());var i=this.nextUnit(),n=this.getArmy(i).playerName;setTimeout(()=>this.eventBus.publish("battlestate",`${n} ${i.type} unit is next to act`),0)},Game.Battle.prototype.onEnd=function(e){this.battleState="finished",this.eventBus.publish("battleended",e),this.eventBus.publish("battlestate",this.getBattleStateText())},Game.Battle.prototype.unitMoving=function(e,t,i,n){requestMove(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.unitTurning=function(e,t,i){requestTurn(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.unitAttacking=function(e,t,i){requestAttack(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.getUnitState=function(e){return e?e.endurance<=0?"dead":e.mobility>0?"moving":e.agility>0?"turning":e.attacks>0?"attacking":void 0:"none"},Game.Battle.prototype.getUnitAt=function(e,t){return this.getUnits().find(i=>i.pos.x==e&&i.pos.y==t)},Game.Battle.prototype.isPlayerArmy=function(e,t){return t?this.selfArmy===this.getArmy(e).playerId:this.selfArmy===this.getArmy(e).playerId||"_"+this.selfArmy===this.getArmy(e).playerId||this.selfArmy==="_"+this.getArmy(e).playerId},Game.Battle.prototype.getBattleStateText=function(){return"none"==this.battleState?"":"created"==this.battleState?`Army of ${this.firstArmy.playerName} has arrived`:"ready"==this.battleState?`Army of ${this.secondArmy.playerName} has arrived`:"started"==this.battleState?`Army of ${this.firstArmy.playerName} is fighting with army of ${this.secondArmy.playerName}`:"finished"==this.battleState?this.firstArmy.units.some(e=>e.endurance>0)?`Army of ${this.firstArmy.playerName} has won`:`Army of ${this.secondArmy.playerName} has won`:void 0};var Game,defaultHeaders={"Content-Type":"application/json"},fetchOpts={get:{method:"GET",credentials:"include",defaultHeaders:defaultHeaders},post:{method:"POST",credentials:"include",defaultHeaders:defaultHeaders}};(Game=Game||{}).fetch=function(){return{get:e=>fetch(e,fetchOpts.get).then(e=>e.text()).then(e=>JSON.parse(e)),post:(e,t)=>{var i=t?Object.assign({},fetchOpts.post,{body:JSON.stringify(t),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"}}):fetchOpts.post;return fetch(e,i).then(e=>e.text()).then(e=>JSON.parse(e))}}};