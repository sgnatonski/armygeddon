function Animator(){var e,t,n=[];return{registerAnimation:(t,i,a)=>{n[t]=i,e=a},getAnimation:(i,a)=>t=getUnitMoveAnim(a,n[i],e).then(()=>t=null),isAnimating:()=>t}}function Damage(){var e=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],t=(t,n,i,a)=>{var r=i-t,s=a-n;return e.findIndex(e=>e.x==r&&e.y==s)+1};return{getRangeDamage:(e,n)=>{var i=e.damage+e.charge/2-n.armor,a=Math.max(...[Math.abs(e.pos.x-n.pos.x),Math.abs(e.pos.y-n.pos.y)]),r=t(n.pos.x,n.pos.y,e.pos.x,e.pos.y),s=n.directions.some(e=>e==r);(1==a||s)&&(a=2*e.range);return Math.floor(i*e.range/a)},getChargeDamage:(e,n)=>{var i=Math.pow(e.charge-1,2),a=t(e.pos.x,e.pos.y,n.pos.x,n.pos.y),r=t(n.pos.x,n.pos.y,e.pos.x,e.pos.y),s=e.directions.some(e=>e==a),o=n.directions.some(e=>e==r);s&&e.directions[0]==n.directions[0]&&(i*=2),(i<0||!s)&&(i=0);var d=o?n.armor:0;return e.damage+i-d}}}function EventBus(){var e={};return{on:(t,n)=>{e[t]||(e[t]=[]),e[t].push(n)},publish:(t,n)=>{e[t]&&e[t].forEach(e=>e(n))}}}function initGrid(e){function t(e,t){i.selectedHex;if(i.selectedHex=null,void 0!=e&&void 0!=t){var n=i.getHexAt(new BHex.Axial(e,t));i.selectedHex=n}}function n(t,n,a,r){var s=i.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(n.x,n.y),r),o=e.getTerrain();return s.filter(e=>o.find(t=>t.x==e.x&&t.y==e.y)).reduce((e,n)=>{var i=e.map(e=>e.cost).reduce((e,t)=>e+t,-t.cost);return(r||i+n.cost<=a)&&e.push(n),e},[t])}var i=new BHex.Grid(e.getSceneSize());return e.getUnits().forEach(e=>{i.getHexAt(new BHex.Axial(e.pos.x,e.pos.y)).blocked=!0}),e.getTerrain().forEach(e=>{i.getHexAt(new BHex.Axial(e.x,e.y)).cost=e.cost}),{getHexes:function(){return e.getTerrain().map(e=>i.hexes.find(t=>e.x==t.x&&e.y==t.y))},getSelectedHex:()=>i.selectedHex?i.getHexAt(new BHex.Axial(i.selectedHex.x,i.selectedHex.y)):null,getHexAt:(e,t)=>i.getHexAt(new BHex.Axial(e,t)),getUnitAt:(t,n)=>e.getUnitAt(t,n),getUnits:function(){return e.getUnits()},isPlayerArmy:(t,n)=>e.isPlayerArmy(t,n),hexSelected:function(a){var r=i.selectedHex;r&&(r.blocked=!1);var s=i.selectedHex?e.getUnitAt(i.selectedHex.x,i.selectedHex.y):null;switch(e.getUnitState(s)){case"moving":(d=(o=n(r,a,s.mobility))[o.length-1]).x==a.x&&d.y==a.y&&e.unitMoving(s,a.x,a.y);break;case"turning":e.unitTurning(s,a.x,a.y);break;case"attacking":var o,d;(d=(o=n(r,a,s.range,!0))[o.length-1]).x==a.x&&d.y==a.y&&e.unitAttacking(s,a.x,a.y);break;default:if(s=e.nextUnit()){var l=i.getHexAt(new BHex.Axial(s.pos.x,s.pos.y));t(l.x,l.y)}}},getSelectedHexRange:function(){var t=i.selectedHex?e.getUnitAt(i.selectedHex.x,i.selectedHex.y):null;if(t){var n=e.getUnitState(t),a=[];a="moving"==n?i.getRange(new BHex.Axial(i.selectedHex.x,i.selectedHex.y),t.mobility):"turning"==n?function(e){for(var t=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],n=e.directions[0],i=[t[n-1]],a=1;a<=e.agility;a++){var r=n-1-a;r<0&&(r=t.length+r);var s=n-1+a;s>t.length-1&&(s-=t.length),i.push(t[r]),i.push(t[s])}return i}(t).map(e=>i.getHexAt(new BHex.Axial(t.pos.x+e.x,t.pos.y+e.y))):i.getRange(new BHex.Axial(i.selectedHex.x,i.selectedHex.y),t.range,!0);var r=e.getTerrain();return a.filter(e=>r.find(t=>t.x==e.x&&t.y==e.y))}return[]},getSelectedHexState:function(){return e.getUnitState(i.selectedHex?e.getUnitAt(i.selectedHex.x,i.selectedHex.y):null)},getPathBetween:function(t,i){var a=e.getUnitAt(t.x,t.y);return a?n(t,i,a.mobility):[]},getSelectedHexMoveCost:(t,n)=>i.selectedHex?function(t,n,a){var r=i.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(n.x,n.y)),s=e.getTerrain();return(r.filter(e=>s.find(t=>t.x==e.x&&t.y==e.y))||[]).map(e=>e.cost).reduce((e,t)=>e+t,[])}(i.selectedHex,i.getHexAt(new BHex.Axial(t,n)),e.getUnitAt(i.selectedHex.x,i.selectedHex.y)):null,initDrawing:function(e){var t=new BHex.Drawing.Options(30,BHex.Drawing.Static.Orientation.PointyTop,new BHex.Drawing.Point(e.x,e.y));BHex.Drawing.Drawing(i,t)},updateSelection:function(n){i.getHexAt(new BHex.Axial(n.pos.x,n.pos.y)).blocked=!0;var a=e.nextUnit(),r=i.getHexAt(new BHex.Axial(a.pos.x,a.pos.y));return t(r.x,r.y),r}}}function setupStage(e,t,n){var i=window.innerWidth,a=window.innerHeight,r={x:i/2,y:a/2},s=new Konva.Stage({container:"container",width:i,height:a});window.addEventListener("resize",e=>{s.width(window.innerWidth),s.height(window.innerHeight)}),e.initDrawing(r);var o=new Animator,d=createEffectLayer(r),l=createUnitLayer(r,e,o),u=createHighlightLayer(r),c=createTerrainLayer(),g=createTooltipLayer(s),h=new Konva.Layer,x=new Konva.Rect({x:0,y:0,width:i,height:a,fill:"black",opacity:.5});h.add(x),t.on("battlestarted",()=>{x.hide(),h.draw()});var y=null;t.on("unitdelta",t=>{y=e.getPathBetween(e.getHexAt(t.source.x,t.source.y),e.getHexAt(t.target.x,t.target.y))}),t.on("battleupdated",t=>{o.getAnimation(t.currUnit.id,y).then(()=>{var n=e.updateSelection(t.currUnit);e.isPlayerArmy(t.nextUnit.id)&&(u.highlightNode(n),u.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState())),l.refresh()})});c.addGridNodes(e,function(t){var i=createTerrainVisual(t,r,n);return i.on("click",()=>{u.highlightNode(null),d.drawPath([]),u.highlightRange([],e.getSelectedHexState()),e.hexSelected(t)}),i.on("mouseenter",()=>{if(!o.isAnimating()){var n=null,i=e.getSelectedHex();i&&(n=e.getUnitAt(i.x,i.y));var a=e.getUnitAt(t.x,t.y),r=e.getSelectedHexState();if(e.isPlayerArmy(n.id)&&(u.highlightNode(t),d.drawPath(e.getPathBetween(e.getSelectedHex(),t)),u.highlightRange(e.getSelectedHexRange(),r)),"moving"==r||"turning"==r){if(n&&a)g.updateTooltipWithUnitStats(a);else if(!a){var s=e.getSelectedHexMoveCost(t.x,t.y);g.updateTooltipWithMoveStats(n,s)}}else"attacking"==r&&n&&a&&g.updateTooltipWithAttackStats(n,a)}}),i.on("mouseleave",()=>{o.isAnimating()||(u.highlightNode(null),g.hideTooltip())}),{node:i,coord:createHexCoordVisual(t,r)}}),s.add(c),s.add(u),s.add(d),s.add(l.node),s.add(g.node),s.add(h),e.hexSelected();var m=e.getSelectedHex();if(m){var p=e.getUnitAt(m.x,m.y);e.isPlayerArmy(p.id)&&(u.highlightNode(m),u.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState()))}}(Game=Game||{}).Army=function(e,t){this.playerId=e.id,this.playerName=e.name,this.unitTypes=t,this.units=Object.keys(e.units).map(t=>e.units[t])},Game.Army.prototype.getArmy=function(){return this.units},Game.Army.prototype.restoreUnit=function(e){var t=this.units.find(t=>t.id==e.id);Object.assign(t,e)};(Game=Game||{}).Battle=function(e){this.eventBus=e,this.eventBus.on("update",e=>this.onUpdate(e))},Game.Battle.prototype.getSceneSize=function(){var e=this.terrain.map(e=>e.x),t=this.terrain.map(e=>e.y),n=Math.abs(Math.min(...e)),i=Math.abs(Math.max(...e)),a=Math.abs(Math.min(...t)),r=Math.abs(Math.max(...t));return Math.max(...[n,i,a,r])},Game.Battle.prototype.load=function(){var e=sessionStorage.getItem("singlebattleid"),t=`/singlebattle/join/${e||""}`;return Game.fetch().post(t).then(e=>(this.loadData(e,!0),Promise.resolve(this)))},Game.Battle.prototype.loadData=function(e,t){var n=Object.keys(e.armies).map(t=>e.armies[t]);sessionStorage.setItem(t?"singlebattleid":"battleid",e.id),this.id=e.id,this.selfArmy=e.selfArmy,this.terrain=e.terrain,this.unitQueue=e.turns[e.turns.length-1].readyUnits,this.firstArmy=new Game.Army(n[0],e.unitTypes),2==n.length&&(this.secondArmy=new Game.Army(n[1],e.unitTypes),setTimeout(()=>this.eventBus.publish("battlestarted"),0))},Game.Battle.prototype.getTerrain=function(){return this.terrain},Game.Battle.prototype.getUnits=function(){return this.secondArmy?this.firstArmy.getArmy().concat(this.secondArmy.getArmy()):this.firstArmy.getArmy()},Game.Battle.prototype.nextUnit=function(){return this.getUnits().find(e=>e.id==this.unitQueue[0])},Game.Battle.prototype.getArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.firstArmy:this.secondArmy},Game.Battle.prototype.getOtherArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.secondArmy:this.firstArmy},Game.Battle.prototype.onUpdate=function(e){if(this.isDefeatedArmy(e.currUnit.id)&&alert("DEFEAT"),this.isWinningArmy(e.currUnit.id))alert("VICTORY");else{this.eventBus.publish("unitdelta",{source:this.nextUnit().pos,target:e.currUnit.pos}),this.unitQueue=e.unitQueue;if(this.getArmy(e.currUnit.id).restoreUnit(e.currUnit),e.targetUnit){this.getArmy(e.targetUnit.id).restoreUnit(e.targetUnit)}this.getArmy(e.nextUnit.id).restoreUnit(e.nextUnit),this.eventBus.publish("battleupdated",e)}},Game.Battle.prototype.unitMoving=function(e,t,n,i){requestMove(this.eventBus,this.id,e.id,t,n)},Game.Battle.prototype.unitTurning=function(e,t,n){requestTurn(this.eventBus,this.id,e.id,t,n)},Game.Battle.prototype.unitAttacking=function(e,t,n){requestAttack(this.eventBus,this.id,e.id,t,n)},Game.Battle.prototype.getUnitState=function(e){return e?e.endurance<=0?"dead":e.mobility>0?"moving":e.agility>0?"turning":e.attacks>0?"attacking":void 0:"none"},Game.Battle.prototype.getUnitAt=function(e,t){return this.getUnits().find(n=>n.pos.x==e&&n.pos.y==t)},Game.Battle.prototype.isWinningArmy=function(e){return!this.getOtherArmy(e).units.some(e=>e.endurance>0)},Game.Battle.prototype.isDefeatedArmy=function(e){return!this.getArmy(e).units.some(e=>e.endurance>0)},Game.Battle.prototype.isPlayerArmy=function(e,t){return t?this.selfArmy===this.getArmy(e).playerId:this.selfArmy===this.getArmy(e).playerId||"_"+this.selfArmy===this.getArmy(e).playerId||this.selfArmy==="_"+this.getArmy(e).playerId};var Game,defaultHeaders={"Content-Type":"application/json"},fetchOpts={get:{method:"GET",credentials:"include",defaultHeaders:defaultHeaders},post:{method:"POST",credentials:"include",defaultHeaders:defaultHeaders}};(Game=Game||{}).fetch=function(){return{get:e=>fetch(e,fetchOpts.get).then(e=>e.text()).then(e=>JSON.parse(e)),post:(e,t)=>{var n=t?Object.assign({},fetchOpts.post,{body:JSON.stringify(t),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"}}):fetchOpts.post;return fetch(e,n).then(e=>e.text()).then(e=>JSON.parse(e))}}};function requestMove(e,t,n,i,a){Game.fetch().post(`/singlebattle/${t}/${n}/move/${i}/${a}`).then(t=>{e.publish("update",t)})}function requestTurn(e,t,n,i,a){Game.fetch().post(`/singlebattle/${t}/${n}/turn/${i}/${a}`).then(t=>{e.publish("update",t)})}function requestAttack(e,t,n,i,a){Game.fetch().post(`/singlebattle/${t}/${n}/attack/${i}/${a}`).then(t=>{e.publish("update",t)})}var ws=null;function initWebSocket(e,t){var n=sessionStorage.getItem("battleid");if(!n||"null"==n)return Game.fetch().post("/battle/start").then(e=>{i(e)});i(n);function i(n){(ws=new WebSocket(`ws://${window.location.host}?bid=${n}`)).onmessage=function(n){var i=JSON.parse(n.data);"data"==i.msg?t(i.data):"upd"==i.msg&&e.publish("update",i.data)},window.addEventListener("beforeunload",function(){ws.close()})}}function requestMove(e,t,n,i,a){ws.send(JSON.stringify({cmd:"move",uid:n,x:i,y:a}))}function requestTurn(e,t,n,i,a){ws.send(JSON.stringify({cmd:"turn",uid:n,x:i,y:a}))}function requestAttack(e,t,n,i,a){ws.send(JSON.stringify({cmd:"attack",uid:n,x:i,y:a}))}