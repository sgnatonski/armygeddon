function Animator(){var e,t,i=[];return{registerAnimation:(t,n,r)=>{i[t]=n,e=r},getAnimation:(n,r)=>t=getUnitMoveAnim(r,i[n],e).then(()=>t=null),isAnimating:()=>t}}function Damage(){var e=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],t=(t,i,n,r)=>{var a=n-t,s=r-i;return e.findIndex(e=>e.x==a&&e.y==s)+1};return{getRangeDamage:(e,i)=>{var n=e.damage+e.charge/2-i.armor,r=Math.max(...[Math.abs(e.pos.x-i.pos.x),Math.abs(e.pos.y-i.pos.y)]),a=t(i.pos.x,i.pos.y,e.pos.x,e.pos.y),s=i.directions.some(e=>e==a);(1==r||s)&&(r=2*e.range);return Math.floor(n*e.range/r)},getChargeDamage:(e,i)=>{var n=Math.pow(e.charge-1,2),r=t(e.pos.x,e.pos.y,i.pos.x,i.pos.y),a=t(i.pos.x,i.pos.y,e.pos.x,e.pos.y),s=e.directions.some(e=>e==r),o=i.directions.some(e=>e==a);s&&e.directions[0]==i.directions[0]&&(n*=2),(n<0||!s)&&(n=0);var d=o?i.armor:0;return e.damage+n-d}}}function EventBus(){var e={};return{on:(t,i)=>{e[t]||(e[t]=[]),e[t].push(i)},publish:(t,i)=>{e[t]&&e[t].forEach(e=>e(i))}}}function initGrid(e){function t(e,t){n.selectedHex;if(n.selectedHex=null,void 0!=e&&void 0!=t){var i=n.getHexAt(new BHex.Axial(e,t));n.selectedHex=i}}function i(t,i,r,a){var s=n.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(i.x,i.y),a),o=e.getTerrain();return s.filter(e=>o.find(t=>t.x==e.x&&t.y==e.y)).reduce((e,i)=>{var n=e.map(e=>e.cost).reduce((e,t)=>e+t,-t.cost);return(a||n+i.cost<=r)&&e.push(i),e},[t])}var n=new BHex.Grid(e.getSceneSize());return e.getUnits().forEach(e=>{n.getHexAt(new BHex.Axial(e.pos.x,e.pos.y)).blocked=!0}),e.getTerrain().forEach(e=>{n.getHexAt(new BHex.Axial(e.x,e.y)).cost=e.cost}),{getHexes:function(){return e.getTerrain().map(e=>n.hexes.find(t=>e.x==t.x&&e.y==t.y))},getSelectedHex:()=>n.selectedHex?n.getHexAt(new BHex.Axial(n.selectedHex.x,n.selectedHex.y)):null,getHexAt:(e,t)=>n.getHexAt(new BHex.Axial(e,t)),getUnitAt:(t,i)=>e.getUnitAt(t,i),getUnits:function(){return e.getUnits()},isPlayerArmy:(t,i)=>e.isPlayerArmy(t,i),hexSelected:function(r){var a=n.selectedHex;a&&(a.blocked=!1);var s=n.selectedHex?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;switch(e.getUnitState(s)){case"moving":(d=(o=i(a,r,s.mobility))[o.length-1]).x==r.x&&d.y==r.y&&e.unitMoving(s,r.x,r.y);break;case"turning":e.unitTurning(s,r.x,r.y);break;case"attacking":var o,d;(d=(o=i(a,r,s.range,!0))[o.length-1]).x==r.x&&d.y==r.y&&e.unitAttacking(s,r.x,r.y);break;default:if(s=e.nextUnit()){var l=n.getHexAt(new BHex.Axial(s.pos.x,s.pos.y));t(l.x,l.y)}}},getSelectedHexRange:function(){var t=n.selectedHex?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null;if(t){var i=e.getUnitState(t),r=[];r="moving"==i?n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),t.mobility):"turning"==i?function(e){for(var t=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],i=e.directions[0],n=[t[i-1]],r=1;r<=e.agility;r++){var a=i-1-r;a<0&&(a=t.length+a);var s=i-1+r;s>t.length-1&&(s-=t.length),n.push(t[a]),n.push(t[s])}return n}(t).map(e=>n.getHexAt(new BHex.Axial(t.pos.x+e.x,t.pos.y+e.y))):n.getRange(new BHex.Axial(n.selectedHex.x,n.selectedHex.y),t.range,!0);var a=e.getTerrain();return r.filter(e=>a.find(t=>t.x==e.x&&t.y==e.y))}return[]},getSelectedHexState:function(){return e.getUnitState(n.selectedHex?e.getUnitAt(n.selectedHex.x,n.selectedHex.y):null)},getPathBetween:function(t,n){var r=e.getUnitAt(t.x,t.y);return r?i(t,n,r.mobility):[]},getSelectedHexMoveCost:(t,i)=>n.selectedHex?function(t,i,r){var a=n.findPath(new BHex.Axial(t.x,t.y),new BHex.Axial(i.x,i.y)),s=e.getTerrain();return(a.filter(e=>s.find(t=>t.x==e.x&&t.y==e.y))||[]).map(e=>e.cost).reduce((e,t)=>e+t,[])}(n.selectedHex,n.getHexAt(new BHex.Axial(t,i)),e.getUnitAt(n.selectedHex.x,n.selectedHex.y)):null,initDrawing:function(e){var t=new BHex.Drawing.Options(30,BHex.Drawing.Static.Orientation.PointyTop,new BHex.Drawing.Point(e.x,e.y));BHex.Drawing.Drawing(n,t)},updateSelection:function(i){n.getHexAt(new BHex.Axial(i.pos.x,i.pos.y)).blocked=!0;var r=e.nextUnit(),a=n.getHexAt(new BHex.Axial(r.pos.x,r.pos.y));return t(a.x,a.y),a}}}function setupStage(e,t,i){var n=window.innerWidth,r=window.innerHeight,a={x:n/2,y:r/2},s=new Konva.Stage({container:"container",width:n,height:r});window.addEventListener("resize",e=>{s.width(window.innerWidth),s.height(window.innerHeight)}),e.initDrawing(a);var o=new Animator,d=createEffectLayer(a),l=createUnitLayer(a,e,o),g=createHighlightLayer(a),u=createTerrainLayer(),c=createTooltipLayer(s),x=new Konva.Layer,h=new Konva.Rect({x:0,y:0,width:n,height:r,fill:"black",opacity:.5});x.add(h),t.on("battlestarted",()=>{h.hide(),x.draw()});var y=null;t.on("unitdelta",t=>{y=e.getPathBetween(e.getHexAt(t.source.x,t.source.y),e.getHexAt(t.target.x,t.target.y))}),t.on("battleupdated",t=>{o.getAnimation(t.currUnit.id,y).then(()=>{var i=e.updateSelection(t.currUnit);e.isPlayerArmy(t.nextUnit.id)&&(g.highlightNode(i),g.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState())),l.refresh()})});u.addGridNodes(e,function(t){var n=createTerrainVisual(t,a,i);return n.on("click",()=>{g.highlightNode(null),d.drawPath([]),g.highlightRange([],e.getSelectedHexState()),e.hexSelected(t)}),n.on("mouseenter",()=>{if(!o.isAnimating()){var i=null,n=e.getSelectedHex();n&&(i=e.getUnitAt(n.x,n.y));var r=e.getUnitAt(t.x,t.y),a=e.getSelectedHexState();if(e.isPlayerArmy(i.id)&&(g.highlightNode(t),d.drawPath(e.getPathBetween(e.getSelectedHex(),t)),g.highlightRange(e.getSelectedHexRange(),a)),"moving"==a||"turning"==a){if(i&&r)c.updateTooltipWithUnitStats(r);else if(!r){var s=e.getSelectedHexMoveCost(t.x,t.y);c.updateTooltipWithMoveStats(i,s)}}else"attacking"==a&&i&&r&&c.updateTooltipWithAttackStats(i,r)}}),n.on("mouseleave",()=>{o.isAnimating()||(g.highlightNode(null),c.hideTooltip())}),{node:n,coord:createHexCoordVisual(t,a)}}),s.add(u),s.add(g),s.add(d),s.add(l.node),s.add(c.node),s.add(x),e.hexSelected();var m=e.getSelectedHex();if(m){var p=e.getUnitAt(m.x,m.y);e.isPlayerArmy(p.id)&&(g.highlightNode(m),g.highlightRange(e.getSelectedHexRange(),e.getSelectedHexState()))}}(Game=Game||{}).Army=function(e,t){this.playerId=e.id,this.playerName=e.name,this.unitTypes=t,this.units=Object.keys(e.units).map(t=>e.units[t])},Game.Army.prototype.getArmy=function(){return this.units},Game.Army.prototype.restoreUnit=function(e){var t=this.units.find(t=>t.id==e.id);Object.assign(t,e)};(Game=Game||{}).Battle=function(e){this.eventBus=e,this.eventBus.on("update",e=>this.onUpdate(e))},Game.Battle.prototype.getSceneSize=function(){var e=this.terrain.map(e=>e.x),t=this.terrain.map(e=>e.y),i=Math.abs(Math.min(...e)),n=Math.abs(Math.max(...e)),r=Math.abs(Math.min(...t)),a=Math.abs(Math.max(...t));return Math.max(...[i,n,r,a])},Game.Battle.prototype.load=function(){var e=sessionStorage.getItem("singlebattleid"),t=`/singlebattle/join/${e||""}`;return Game.fetch().post(t).then(e=>(this.loadData(e,!0),Promise.resolve(this)))},Game.Battle.prototype.loadData=function(e,t){var i=Object.keys(e.armies).map(t=>e.armies[t]);sessionStorage.setItem(t?"singlebattleid":"battleid",e.id),this.id=e.id,this.selfArmy=e.selfArmy,this.terrain=e.terrain,this.unitQueue=e.turns[e.turns.length-1].readyUnits,this.firstArmy=new Game.Army(i[0],e.unitTypes),2==i.length&&(this.secondArmy=new Game.Army(i[1],e.unitTypes),setTimeout(()=>this.eventBus.publish("battlestarted"),0))},Game.Battle.prototype.getTerrain=function(){return this.terrain},Game.Battle.prototype.getUnits=function(){return this.secondArmy?this.firstArmy.getArmy().concat(this.secondArmy.getArmy()):this.firstArmy.getArmy()},Game.Battle.prototype.nextUnit=function(){return this.getUnits().find(e=>e.id==this.unitQueue[0])},Game.Battle.prototype.getArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.firstArmy:this.secondArmy},Game.Battle.prototype.getOtherArmy=function(e){return this.firstArmy.getArmy().some(t=>t.id==e)?this.secondArmy:this.firstArmy},Game.Battle.prototype.onUpdate=function(e){if(this.isDefeatedArmy(e.currUnit.id)&&alert("DEFEAT"),this.isWinningArmy(e.currUnit.id))alert("VICTORY");else{this.eventBus.publish("unitdelta",{source:this.nextUnit().pos,target:e.currUnit.pos}),this.unitQueue=e.unitQueue;if(this.getArmy(e.currUnit.id).restoreUnit(e.currUnit),e.targetUnit){this.getArmy(e.targetUnit.id).restoreUnit(e.targetUnit)}this.getArmy(e.nextUnit.id).restoreUnit(e.nextUnit),this.eventBus.publish("battleupdated",e)}},Game.Battle.prototype.unitMoving=function(e,t,i,n){requestMove(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.unitTurning=function(e,t,i){requestTurn(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.unitAttacking=function(e,t,i){requestAttack(this.eventBus,this.id,e.id,t,i)},Game.Battle.prototype.getUnitState=function(e){return e?e.endurance<=0?"dead":e.mobility>0?"moving":e.agility>0?"turning":e.attacks>0?"attacking":void 0:"none"},Game.Battle.prototype.getUnitAt=function(e,t){return this.getUnits().find(i=>i.pos.x==e&&i.pos.y==t)},Game.Battle.prototype.isWinningArmy=function(e){return!this.getOtherArmy(e).units.some(e=>e.endurance>0)},Game.Battle.prototype.isDefeatedArmy=function(e){return!this.getArmy(e).units.some(e=>e.endurance>0)},Game.Battle.prototype.isPlayerArmy=function(e,t){return t?this.selfArmy===this.getArmy(e).playerId:this.selfArmy===this.getArmy(e).playerId||"_"+this.selfArmy===this.getArmy(e).playerId||this.selfArmy==="_"+this.getArmy(e).playerId};var Game,defaultHeaders={"Content-Type":"application/json"},fetchOpts={get:{method:"GET",credentials:"include",defaultHeaders:defaultHeaders},post:{method:"POST",credentials:"include",defaultHeaders:defaultHeaders}};(Game=Game||{}).fetch=function(){return{get:e=>fetch(e,fetchOpts.get).then(e=>e.text()).then(e=>JSON.parse(e)),post:(e,t)=>{var i=t?Object.assign({},fetchOpts.post,{body:JSON.stringify(t),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"}}):fetchOpts.post;return fetch(e,i).then(e=>e.text()).then(e=>JSON.parse(e))}}};