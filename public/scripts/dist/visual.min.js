function createEffectLayer(e){var a=new Konva.Layer({hitGraphEnabled:!1});a.drawPath=(n=>{a.find(".move_line").each(e=>{e.remove(),e.destroy()});var i=(t=n,t.map(e=>e.center).reduce((a,t)=>a.concat([e.x+t.x,e.y+t.y]),[]));if(i&&i.length){var r=createMoveLineVisual(i);a.add(r)}a.draw()});var t;return a}var imageShapes;function createTerrainVisual(e,a,t){if(!imageShapes){function n(e){return new Konva.Image({image:e,width:70,height:70,offset:{x:35,y:35},rotation:30,perfectDrawEnabled:!1})}imageShapes={plains:t.plains.map(n),forrests:t.forrests.map(n)}}var i=new Konva.Group,r=function(e,a){if(!(e.cost<0)){var t;if(1==e.cost){var n=Math.floor(6*Math.random());t=imageShapes.plains[n].clone()}else n=Math.floor(2*Math.random()),t=imageShapes.forrests[n].clone();return t.x(a.x+e.center.x),t.y(a.y+e.center.y),t}}(e,a);return r&&i.add(r),i.add(createHexVisual(e,a)),i}function createHexVisual(e,a){var t=a;function n(a){return[t.x+e.points[a].x,t.y+e.points[a].y]}return new Konva.Shape({sceneFunc:function(e){e.beginPath(),e.moveTo(...n(0)),e.lineTo(...n(1)),e.lineTo(...n(2)),e.lineTo(...n(3)),e.lineTo(...n(4)),e.lineTo(...n(5)),e.closePath(),e.fillStrokeShape(this)},stroke:"#003300",strokeWidth:.7,strokeHitEnabled:!1,perfectDrawEnabled:!1})}function createHexCoordVisual(e,a){var t=new Konva.Text({x:a.x+e.center.x,y:a.y+e.center.y,text:`${e.x}, ${e.y}`,fontSize:10,fill:"black",listening:!1,perfectDrawEnabled:!1});return t.setOffset({x:t.getWidth()/2,y:t.getHeight()/2}),t}function createHighlightLayer(e){var a=new Konva.Layer({hitGraphEnabled:!1}),t=null;a.highlightNode=(n=>{if(t&&(t.remove(),t.destroy()),n){var i=createHexVisual(n,e);i.setFill("#ffffff"),i.setListening(!1),i.opacity(.2),a.add(i),t=i}a.draw()});return a.highlightRange=((n,i)=>{switch(i){case"moving":!function(t){if(a.destroyChildren(),t)for(var n=0;n<t.length;n++){var i=createHexVisual(t[n],e);i.setFill("#ffffff"),i.setListening(!1),i.opacity(.2),a.add(i)}}(n);break;case"turning":!function(t){if(a.destroyChildren(),t)for(var n=0;n<t.length;n++){var i=createHexVisual(t[n],e);i.setFill("#ffad33"),i.setListening(!1),i.opacity(.2),a.add(i)}}(n);break;case"attacking":!function(t){if(a.destroyChildren(),t)for(var n=0;n<t.length;n++){var i=createHexVisual(t[n],e);i.setFill("#DD1111"),i.opacity(.5),i.setListening(!1),a.add(i)}}(n);break;default:a.destroyChildren()}t&&a.add(t),a.draw()}),a}function createMoveLineVisual(e){return new Konva.Line({points:e,stroke:"#ccffff",shadowColor:"black",strokeWidth:10,lineCap:"round",lineJoin:"round",dash:[1,12,1,15],tension:.3,name:"move_line",listening:!1,strokeHitEnabled:!1,perfectDrawEnabled:!1})}function getShape(e){switch(e){case"unitBack":return"M 316 308 c -11 0 -22 -7 -26 -17 l -2 -5 l 45 -7 a 6 6 0 0 0 5 -7 c -6 -37 -7 -76 -3 -113 l 1 -12 a 107 107 0 0 0 -74 -114 c -13 -4 -23 -15 -26 -29 c 0 -2 -2 -4 -5 -4 a 6 6 0 0 0 -5 5 c -3 13 -13 24 -26 28 a 106 106 0 0 0 -74 114 l 1 12 a 415 415 0 0 1 -2 117 l 4 3 l 48 7 l -2 5 c -5 10 -15 17 -27 17 h -2 c -32 0 -58 26 -58 58 v 91 c 0 3 2 5 5 5 h 276 c 3 0 5 -2 5 -5 v -91 c 0 -32 -26 -58 -58 -58 z";case"unitPath":return"M316 308c-11 0-22-7-26-17l-2-5 45-7a6 6 0 0 0 5-7c-6-37-7-76-3-113l1-12a107 107 0 0 0-74-114c-13-4-23-15-26-29 0-2-2-4-5-4a6 6 0 0 0-5 5c-3 13-13 24-26 28a106 106 0 0 0-74 114l1 12a415 415 0 0 1-2 117l4 3 48 7-2 5c-5 10-15 17-27 17h-2c-32 0-58 26-58 58v91c0 3 2 5 5 5h276c3 0 5-2 5-5v-91c0-32-26-58-58-58zm47 58v59a61 61 0 0 1-70-60c0-18 8-35 22-46h1c26 0 47 21 47 47zm-132-63c-14 0-27-5-37-14l17 3a5 5 0 0 0 7-7l-2-10a66 66 0 0 0 30 0l-1 10a6 6 0 0 0 6 7l17-3c-10 9-23 14-37 14zm18-40a55 55 0 0 1-35 0l-14-75c-1-3-3-4-6-4h-16a19 19 0 0 1-20-21c0-10 9-19 20-19h106a19 19 0 0 1 20 20c0 11-9 20-20 20h-16c-3 0-5 1-6 4l-13 75zM138 157l-1-11a96 96 0 0 1 66-103c9-2 17-8 23-14v86a6 6 0 0 0 11 0V29c5 6 13 12 22 14a95 95 0 0 1 66 103l-1 11c-4 37-3 75 2 112l-69 11 15-85h12c17 0 31-14 31-30a30 30 0 0 0-31-32H178c-16 0-30 14-31 30a30 30 0 0 0 31 32h12l15 85-69-11c6-37 6-75 2-112zm8 162h1c14 11 22 28 22 46a61 61 0 0 1-70 60v-59c0-26 21-47 47-47zM99 436a72 72 0 0 0 81-71c0-18-7-35-19-48 10-4 19-11 24-22 11 11 25 18 40 19v137H99v-15zm137 15V314c17-1 32-9 43-21l1 2c4 10 12 17 22 21a72 72 0 0 0 62 120v15H235z";case"inf1":return"M237.3 60.5c-4.7 3.5-68.5 51-150.2 67.3-10.8 188.8 150 286.5 150.2 286.4 0 0 161-97.6 150.2-286.4-81.8-16.3-150.2-67.3-150.2-67.3z";case"inf2":return"M440.6 97.4a12.6 12.6 0 0 0-10-11.6c-99.8-20-185-82.7-185.8-83.3a12.6 12.6 0 0 0-15.2 0C226.3 5.2 146.2 65.4 44 85.9c-5.6 1.1-9.8 6-10.1 11.6-8.2 143.4 59 246.6 117 307.9a479.7 479.7 0 0 0 73 63c7 4.8 9.1 6.1 13 6.2h.5c4 0 6.3-1.5 12.4-5.7a473 473 0 0 0 65.3-54.7c37.3-37.5 67-79.4 88.3-124.3a392.4 392.4 0 0 0 37.2-192.4zm-110.4 262a442 442 0 0 1-93 87.5 442 442 0 0 1-92.8-87.5c-60-75.2-88.8-159.6-85.8-251C145 89 214.8 44 237.3 28.2c22.9 15.8 94 61.1 178.6 80.4 3 91.3-25.8 175.7-85.7 250.9z";case"arch":return"M301.3 246.2l-55.7-19s-2.3-1.1-3.2-2L188 170.8c-1.1-.7-.4-1.8 0-2.2L288.5 68.1c24.1-24.1 14.5-46.3-8.3-23.5-6 6-18.3 6.2-33.6 3l-10.2-2.4C200.9 37 161 27.8 101 82.1c-.3.3-1.1 1.2-2.4-.1C87 70.4 78 61 69.8 52.7c-1.8-1.9-.4-3.1-.4-3.1l4.4-4.4c5.5-5.5 4.2-12.6-2.8-15.9l-61-28C3-2 0 1.2 3.1 8.2l28 61c3.3 7 10.5 8.3 16 2.8l3.4-3.5s2-2.5 4-.5l28.4 28.4c1.5 1.3 1.3 2.4 1 2.7-56 61.2-45.6 108.2-37.2 146.3l.4 1.8c3.7 16.7 2.2 29.9-5.8 37.9-17.3 17.3-11.2 41.4 26.4 3.8l103-103c.3-.2.9-.7 2 .3l54.6 54.6c.7.7 1.7 2.9 1.7 2.9l19 55.8c2.6 7.4 7.1 7.5 10.2.4l7.5-17.5c3-7.2 11.4-15.5 18.5-18.5l17.5-7.5c7.2-3.1 7-7.7-.4-10.2zM231 69c3.5.8 7 1.7 10.7 2.4 4.3 1 8.4 1.6 12.3 2L173.2 154c-1.1 1-2.2-.2-2.2-.2l-52.5-52.6c-.9-1-.5-1.6-.2-1.9 49.9-45 80.4-37.9 112.6-30.4zm-158 185.3c-.3-3.9-1-8-2-12.4l-.4-1.8c-7.8-35.6-16-72.4 30.7-123.7.3-.3 1.2-.6 2 .3l53 53s.5.9-.3 1.7l-83 83z";case"cav1":return"M82.2 50c-.5-.2-13.1-3-12.6-22.7.3-10.7-6.3-18.8-19.2-23.5A69.4 69.4 0 0 0 31.7 0a3 3 0 0 0-2.9 2.3 3 3 0 0 0-2.3 2l-.6 2-1.7-1.7a3 3 0 0 0-3.4-.6l-1.2.6a3 3 0 0 0-1.7 3l.1 1.5c.1 1.4.2 3 .7 4.6.4 1.3.3 2.2-.5 3.4A20.5 20.5 0 0 0 14 30.8c.3 4.3-2.3 8.4-5.3 12.7-3.4 4.9-1.1 9 .3 11.5a9.7 9.7 0 0 0 11 4c2.1-.7 4-2.8 4.6-4.9 1-3.5 3.7-5.4 7-7.6l1.8-1.4 2.6-1.3c1.3 10.6-.2 18.4-5 24.7a19.3 19.3 0 0 0-2.1 20.7l.1.3a3 3 0 0 0 3.6 1.9 58.2 58.2 0 0 0 34.6-27.7c.4.3.9.1 1.2-.2h.7c7.6 0 14.2-7.9 15-8.8a3 3 0 0 0-1.8-4.8zM31.7 88.4c0-.2 0-.4-.2-.6-2.7-6-2.4-11.9 1.8-17.5 6-8.1 6.8-17.5 5.5-27.1-.1-1.3-1-2.4-1.5-3.5-2.3 1.2-4.2 1.8-5.7 3-4 2.8-8.5 5.2-10 10.5a4.9 4.9 0 0 1-2.7 3l-1.7.2c-2.3 0-4.8-1.2-5.7-3-1.5-2.6-2.7-5-.4-8.3 3-4.4 6.2-9.2 5.8-14.6-.3-4.8 1.4-8.2 3.8-11.8a6.5 6.5 0 0 0 .9-6C21 11 21 9 20.9 7.2l1.2-.6 5.3 5 2-6.5L32 9.4l1.6 2.6c.1.4.4.7 1 .7 23 .2 22.4 32 30.6 48.2a55.2 55.2 0 0 1-33.5 27.6zm37.3-28c-.6 0-1.2 0-1.8-.2-8.9-16.5-7.8-48.3-31.6-49.5L31.7 3s35.6 1.6 35 24.2C66 50 81.6 53 81.6 53s-6.3 7.7-12.7 7.7z";case"cav2":return"M20.9 29.9c-1.3 0-1.3 2 0 2s1.3-2 0-2zM12.5 48.2c-1.1-.6-2.1 1.1-1 1.7.7.4 1.1.9 1 1.7 0 .5.5 1 1 1 .6 0 1-.5 1-1 .2-1.5-.8-2.8-2-3.4z";default:return}}function loadImages(){return load(["/images/grid/plain1.png","/images/grid/plain2.png","/images/grid/plain3.png","/images/grid/plain4.png","/images/grid/plain5.png","/images/grid/plain6.png","/images/grid/forrest1.png","/images/grid/forrest2.png"]).then(e=>({plains:e.slice(0,6),forrests:[e[6],e[7]]}))}function createTerrainLayer(){var e=new Konva.Layer;return e.addGridNodes=((a,t)=>{var n=999999999,i=999999999,r=0,o=0;e.destroyChildren(),a.getHexes().sort((e,a)=>(e.points.forEach(e=>{e.x<n&&(n=e.x),e.x>r&&(r=e.x),e.y<i&&(i=e.y),e.y>o&&(o=e.y)}),e.y>a.y?1:e.y<a.y?-1:e.x>a.x?1:e.x<a.x?-1:0)).map(e=>t(e)).forEach(a=>{e.add(a)}),e.setHeight(Math.abs(i)+Math.abs(o)),e.setWidth(Math.abs(n)+Math.abs(r))}),e}function createTooltipLayer(e){var a=new Konva.Layer({hitGraphEnabled:!1}),t=createTooltipVisual();a.add(t.node);return{node:a,updateTooltipWithUnitStats:function(n){var i=e.getPointerPosition(),r=[`Endurance: ${n.endurance} / ${n.lifetime.endurance}`,`Mobility: ${n.mobility} / ${n.lifetime.mobility}`,`Agility: ${n.agility} / ${n.lifetime.agility}`,`Damage: ${n.damage}`,`Armor: ${n.armor}`,`Range: ${n.range}`];t.show(r,i,r.length),a.batchDraw()},updateTooltipWithMoveStats:function(n,i){var r=e.getPointerPosition();if(i<=n.mobility){var o=[`Moves: ${i} / ${n.mobility}`,`Charge: ${i}`];n.agility&&i==n.mobility&&o.push(`Agility: -${n.agility}`),t.show(o,r,o.length),a.batchDraw()}},updateTooltipWithAttackStats:function(n,i){var r=Damage().getChargeDamage(n,i),o=e.getPointerPosition(),c=[`Endurance: ${i.endurance}`,`-${r} damage`];t.show(c,o,c.length),a.batchDraw()},hideTooltip:function(){t.hide(),a.draw()}}}function createTooltipVisual(){var e=new Konva.Rect({width:100,height:50,cornerRadius:3,fill:"grey",stroke:"#252525",strokeWidth:2,opacity:.8,listening:!1,shadowColor:"black",shadowBlur:5,shadowOffset:{x:6,y:6},shadowOpacity:.5,perfectDrawEnabled:!1}),a=new Konva.Text({fontFamily:"Calibri",fontSize:11,padding:5,fill:"#dedede",listening:!1,perfectDrawEnabled:!1}),t=new Konva.Group({listening:!1});return t.add(e),t.add(a),t.hide(),{show:(n,i,r)=>{r||(r=1),a.text(n.join("\n")),t.position({x:i.x+5,y:i.y+5}),e.height(10+11*r),t.show()},hide:()=>{t.hide()},node:t}}function createUnitLayer(e,a,t){var n=new Konva.Layer({hitGraphEnabled:!1}),i=["#00cc00","#c80b04"],r=[];a.getUnits().forEach(e=>{!function(e,t){var i=o(e,t,a.isPlayerArmy(e.id,!0));n.add(i)}(e,a.getHexAt(e.pos.x,e.pos.y).center)});function o(a,n,o){var c=a.endurance>0?createUnitVisual(a,e,n,o?i[0]:i[1]):createDeadUnitVisual(a,e,n);return t.registerAnimation(a.id,c,e),r.push({node:c,unit:a,isPlayerArmy:o,hexCenter:n}),c}return{node:n,refresh:()=>{n.destroyChildren();var e=r.slice();r=[],e.forEach(e=>{var a=o(e.unit,e.hexCenter,e.isPlayerArmy);a.setX(e.node.getX()),a.setY(e.node.getY()),n.add(a)}),n.draw()}}}function getUnitMoveAnim(e,a,t){return new Promise(function(n,i){if(e.length<=1)n();else{var r=e.shift(),o=new Konva.Animation(function(i){var c=i.time/400,l=t.y+r.center.y,d=t.y+e[0].center.y,s=d-l,h=l+s*c;a.setY(h);var f=t.x+r.center.x,g=t.x+e[0].center.x,u=g-f,y=f+u*c;a.setX(y),(u>0&&y>=g||u<0&&y<=g||s>0&&h>=d||s<0&&h<=d)&&(r=e.shift(),i.time=0,e.length||(o.stop(),a.setY(d),a.setX(g),n()))},a.getLayer());o.start()}})}function createUnitVisual(e,a,t,n){var i=new Konva.Path({data:getShape("unitBack"),fill:n,scale:{x:.08,y:.08},offsetY:60,shadowColor:"black",shadowBlur:10,shadowOffset:{x:40,y:20},shadowOpacity:.5,perfectDrawEnabled:!1}),r=new Konva.Path({data:getShape("unitPath"),fill:"#000000",scale:{x:.08,y:.08},offsetY:60,perfectDrawEnabled:!1}),o=new Konva.Group({offset:{x:-18,y:-17}});switch(o.add(new Konva.Circle({radius:10,fill:"white",stroke:"black",strokeWidth:1,offset:{x:-8,y:-8},opacity:.7,perfectDrawEnabled:!1})),e.type){case"inf":o.add(new Konva.Path({data:getShape("inf1"),fill:"#000000",scale:{x:.035,y:.035},perfectDrawEnabled:!1})),o.add(new Konva.Path({data:getShape("inf2"),fill:"#222222",scale:{x:.035,y:.035},perfectDrawEnabled:!1}));break;case"arch":o.add(new Konva.Path({data:getShape("arch"),fill:"#000000",scale:{x:.04,y:.04},offset:{x:-80,y:-80},perfectDrawEnabled:!1}));break;case"cav":o.add(new Konva.Path({data:getShape("cav1"),fill:"#222222",scale:{x:.2,y:.2},perfectDrawEnabled:!1})),o.add(new Konva.Path({data:getShape("cav2"),fill:"#222222",scale:{x:.2,y:.2},perfectDrawEnabled:!1}))}var c=new Konva.Group,l=new Konva.Rect({width:2,height:30,fill:"white",stroke:"black",strokeWidth:1,strokeHitEnabled:!1,perfectDrawEnabled:!1}),d=new Konva.Shape({sceneFunc:function(a){var t=e.endurance/e.lifetime.endurance;t<0&&(t=0);var n=Math.floor(30*t);a.beginPath(),a.rect(0,30-n,2,n),a.closePath(),a.fillStrokeShape(this)},fill:"green",stroke:"black",strokeWidth:.5,strokeHitEnabled:!1,perfectDrawEnabled:!1});c.add(l),c.add(d);var s=new Konva.Shape({x:19,y:15,fill:"#ffff66",opacity:.35,perfectDrawEnabled:!1,sceneFunc:function(a){if(e.armor){var t=0;e.directions.length>1&&(t=1);var n=60*(e.directions[0]-1)-30-60*t,i=60*e.directions.length;a.rotate(Konva.getAngle(n)),a.beginPath(),a.arc(0,0,32,0,Konva.getAngle(i),!1),a.lineTo(0,0),a.closePath(),a.fillStrokeShape(this)}}}),h=new Konva.Group({listening:!1,x:a.x+t.x,y:a.y+t.y,offset:{x:19,y:15}});return h.add(s),h.add(i),h.add(r),h.add(o),h.add(c),h}function createDeadUnitVisual(e,a,t){var n=new Konva.Path({data:getShape("unitBack"),fill:"#777777",scale:{x:.08,y:.08},offsetY:60,shadowColor:"black",shadowBlur:10,shadowOffset:{x:40,y:20},shadowOpacity:.5,perfectDrawEnabled:!1}),i=new Konva.Group({listening:!1,x:a.x+t.x,y:a.y+t.y,offset:{x:19,y:15}});return i.add(n),i}function createWaitLayer(e,a){var t=new Konva.Layer({hitGraphEnabled:!1}),n=new Konva.Rect({x:0,y:0,width:e,height:a,fill:"black",opacity:.5});t.add(n);var i=320;function r(a){return new Konva.Text({x:e/2-i/2,y:100,text:a,fontSize:16,fontFamily:"Calibri",fill:"#555",width:i,padding:20,align:"center"})}var o=r(),c=new Konva.Rect({x:e/2-i/2,y:100,stroke:"#555",strokeWidth:5,fill:"#ddd",width:i,shadowColor:"black",shadowBlur:10,shadowOffset:[10,10],shadowOpacity:.2});return t.add(c),t.add(o),{show:function(e){n.show(),o=r(e),t.add(o),c.setHeight(o.getHeight()),c.show(),t.draw()},hide:function(){n.hide(),o.destroy(),c.hide(),t.draw()},node:t}}