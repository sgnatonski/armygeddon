"use strict";function load(e){if(!e)return Promise.reject();if("string"==typeof e){var t=e;(e=new Image).src=t}else{if(void 0!==e.length){var n=[].map.call(e,function(e){return load(e).catch(function(e){return e})});return Promise.all(n).then(function(e){var t=e.filter(function(e){return e.naturalWidth});return t.length===e.length?t:Promise.reject({loaded:t,errored:e.filter(function(e){return!e.naturalWidth})})})}if("IMG"!==e.tagName)return Promise.reject()}var r=new Promise(function(t,n){function r(){e.naturalWidth?t(e):n(e),e.removeEventListener("load",r),e.removeEventListener("error",r)}e.naturalWidth?t(e):e.complete?n(e):(e.addEventListener("load",r),e.addEventListener("error",r))});return r.image=e,r}module.exports=load;var define,__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();function JL(e){if(!e)return JL.__;Array.prototype.reduce||(Array.prototype.reduce=function(e,t){for(var n=t,r=0;r<this.length;r++)n=e(n,this[r],r,this);return n});var t="";return("."+e).split(".").reduce(function(e,n,r,i){t?t+="."+n:t=n;var o=e["__"+t];return void 0===o&&(JL.Logger.prototype=e,o=new JL.Logger(t),e["__"+t]=o),o},JL.__)}!function(e){function t(e,t,n){void 0!==t[e]&&(null!==t[e]?n[e]=t[e]:delete n[e])}function n(t){if(null!=e.enabled&&!e.enabled)return!1;try{if(t.userAgentRegex&&!new RegExp(t.userAgentRegex).test(navigator.userAgent))return!1}catch(e){}try{if(t.ipRegex&&e.clientIP&&!new RegExp(t.ipRegex).test(e.clientIP))return!1}catch(e){}return!0}function r(e,t){try{if(e.disallow&&new RegExp(e.disallow).test(t))return!1}catch(e){}return!0}function i(e){return"function"==typeof e?e instanceof RegExp?e.toString():e():e}e.requestId="",e.entryId=0,e._createXMLHttpRequest=function(){return new XMLHttpRequest},e._getTime=function(){return(new Date).getTime()},e._console=console,e._appenderNames=[];var o=function(){return function(e,t,n){this.msg=e,this.meta=t,this.finalString=n}}();function s(t){var n,r=i(t);switch(typeof r){case"string":return new o(r,null,r);case"number":case"boolean":return n=r.toString(),new o(n,null,n);case"undefined":return new o("undefined",null,"undefined");case"object":return r instanceof RegExp||r instanceof String||r instanceof Number||r instanceof Boolean?(n=r.toString(),new o(n,null,n)):(n="function"==typeof e.serialize?e.serialize.call(this,r):JSON.stringify(r),new o("",r,n));default:return new o("unknown",null,"unknown")}}function a(){return 1e3}function u(){return 2e3}function h(){return 3e3}function f(){return 4e3}function c(){return 5e3}function l(){return 6e3}function d(e){return e<=1e3?"trace":e<=2e3?"debug":e<=3e3?"info":e<=4e3?"warn":e<=5e3?"error":"fatal"}e.setOptions=function(e){return t("enabled",e,this),t("maxMessages",e,this),t("defaultAjaxUrl",e,this),t("clientIP",e,this),t("requestId",e,this),t("defaultBeforeSend",e,this),t("serialize",e,this),this},e.getAllLevel=function(){return-2147483648},e.getTraceLevel=a,e.getDebugLevel=u,e.getInfoLevel=h,e.getWarnLevel=f,e.getErrorLevel=c,e.getFatalLevel=l,e.getOffLevel=function(){return 2147483647};var g=function(){return function(e,t){this.inner=t,this.name="JL.Exception",this.message=s(e).finalString}}();e.Exception=g,g.prototype=new Error;var p=function(){return function(e,t,n,r,i){this.l=e,this.m=t,this.n=n,this.t=r,this.u=i}}();function m(t,n,r){return e.entryId++,new p(t,n,r,e._getTime(),e.entryId)}function b(e){e.id&&(clearTimeout(e.id),e.id=null)}function y(e,t,n){var r=this;e.id||(e.id=setTimeout(function(){n.call(r)},t))}e.LogItem=p;var v=function(){function i(t,n){this.appenderName=t,this.sendLogItems=n,this.level=e.getTraceLevel(),this.sendWithBufferLevel=2147483647,this.storeInBufferLevel=-2147483648,this.bufferSize=0,this.batchSize=1,this.maxBatchSize=20,this.batchTimeout=2147483647,this.sendTimeout=5e3,this.buffer=[],this.batchBuffer=[],this.batchTimeoutTimer={id:null},this.sendTimeoutTimer={id:null},this.nbrLogItemsSkipped=0,this.nbrLogItemsBeingSent=0;var r="Trying to create an appender without a name or with an empty name";if(void 0==t)throw r;if(-1!=e._appenderNames.indexOf(t)){if(!t)throw r;throw"Multiple appenders use the same name "+t}e._appenderNames.push(t)}return i.prototype.addLogItemsToBuffer=function(t){if(this.batchBuffer.length>=this.maxBatchSize)this.nbrLogItemsSkipped+=t.length;else{if(null!=e.maxMessages){if(e.maxMessages<1)return;e.maxMessages-=t.length}this.batchBuffer=this.batchBuffer.concat(t);var n=this;y(this.batchTimeoutTimer,this.batchTimeout,function(){n.sendBatch.call(n)})}},i.prototype.batchBufferHasOverdueMessages=function(){for(var t=0;t<this.batchBuffer.length;t++){if(e._getTime()-this.batchBuffer[t].t>this.batchTimeout)return!0}return!1},i.prototype.batchBufferHasStrandedMessage=function(){return!(null==e.maxMessages)&&e.maxMessages<1&&this.batchBuffer.length>0},i.prototype.sendBatchIfComplete=function(){(this.batchBuffer.length>=this.batchSize||this.batchBufferHasOverdueMessages()||this.batchBufferHasStrandedMessage())&&this.sendBatch()},i.prototype.onSendingEnded=function(){b(this.sendTimeoutTimer),this.nbrLogItemsBeingSent=0,this.sendBatchIfComplete()},i.prototype.setOptions=function(n){if(t("level",n,this),t("ipRegex",n,this),t("userAgentRegex",n,this),t("disallow",n,this),t("sendWithBufferLevel",n,this),t("storeInBufferLevel",n,this),t("bufferSize",n,this),t("batchSize",n,this),t("maxBatchSize",n,this),t("batchTimeout",n,this),t("sendTimeout",n,this),this.bufferSize<this.buffer.length&&(this.buffer.length=this.bufferSize),this.maxBatchSize<this.batchSize)throw new e.Exception({message:"maxBatchSize cannot be smaller than batchSize",maxBatchSize:this.maxBatchSize,batchSize:this.batchSize});return this},i.prototype.log=function(e,t,i,o,s,a,u){var h;n(this)&&r(this,a)&&(s<this.storeInBufferLevel||(h=m(s,a,u),s<this.level?this.bufferSize>0&&(this.buffer.push(h),this.buffer.length>this.bufferSize&&this.buffer.shift()):(this.addLogItemsToBuffer([h]),s>=this.sendWithBufferLevel&&this.buffer.length&&(this.addLogItemsToBuffer(this.buffer),this.buffer.length=0),this.sendBatchIfComplete())))},i.prototype.sendBatch=function(){if(!(this.nbrLogItemsBeingSent>0)&&(b(this.batchTimeoutTimer),0!=this.batchBuffer.length)){this.nbrLogItemsBeingSent=this.batchBuffer.length;var e=this;y(this.sendTimeoutTimer,this.sendTimeout,function(){e.onSendingEnded.call(e)}),this.sendLogItems(this.batchBuffer,function(){e.batchBuffer.splice(0,e.nbrLogItemsBeingSent),e.nbrLogItemsSkipped>0&&(e.batchBuffer.push(m(4e3,"Lost "+e.nbrLogItemsSkipped+" messages. Either connection with the server was down or logging was disabled via the enabled option. Reduce lost messages by increasing the ajaxAppender option maxBatchSize.",e.appenderName)),e.nbrLogItemsSkipped=0),e.onSendingEnded.call(e)})}},i}();e.Appender=v;var x=function(r){function i(t){var n=r.call(this,t,i.prototype.sendLogItemsAjax)||this;return n.xhr=e._createXMLHttpRequest(),n}return __extends(i,r),i.prototype.setOptions=function(e){return t("url",e,this),t("beforeSend",e,this),r.prototype.setOptions.call(this,e),this},i.prototype.sendLogItemsAjax=function(t,r){try{if(!n(this))return;var i=this.xhr.readyState;0!=i&&4!=i&&this.xhr.abort();var o="/jsnlog.logger";null!=e.defaultAjaxUrl&&(o=e.defaultAjaxUrl),this.url&&(o=this.url),this.xhr.open("POST",o),this.xhr.setRequestHeader("Content-Type","application/json"),this.xhr.setRequestHeader("JSNLog-RequestId",e.requestId);var s=this;this.xhr.onreadystatechange=function(){4==s.xhr.readyState&&s.xhr.status>=200&&s.xhr.status<300&&r()};var a={r:e.requestId,lg:t};"function"==typeof this.beforeSend?this.beforeSend.call(this,this.xhr,a):"function"==typeof e.defaultBeforeSend&&e.defaultBeforeSend.call(this,this.xhr,a);var u=JSON.stringify(a);this.xhr.send(u)}catch(e){}},i}(v);e.AjaxAppender=x;var L=function(t){function r(e){return t.call(this,e,r.prototype.sendLogItemsConsole)||this}return __extends(r,t),r.prototype.clog=function(t){e._console.log(t)},r.prototype.cerror=function(t){e._console.error?e._console.error(t):this.clog(t)},r.prototype.cwarn=function(t){e._console.warn?e._console.warn(t):this.clog(t)},r.prototype.cinfo=function(t){e._console.info?e._console.info(t):this.clog(t)},r.prototype.cdebug=function(t){e._console.debug?e._console.debug(t):this.cinfo(t)},r.prototype.sendLogItemsConsole=function(t,r){try{if(!n(this))return;if(!e._console)return;var i;for(i=0;i<t.length;++i){var o=t[i],s=o.n+": "+o.m;"undefined"==typeof window&&(s=new Date(o.t)+" | "+s),o.l<=e.getDebugLevel()?this.cdebug(s):o.l<=e.getInfoLevel()?this.cinfo(s):o.l<=e.getWarnLevel()?this.cwarn(s):this.cerror(s)}}catch(e){}r()},r}(v);e.ConsoleAppender=L;var w,S=function(){function e(e){this.loggerName=e,this.seenRegexes=[]}return e.prototype.setOptions=function(e){return t("level",e,this),t("userAgentRegex",e,this),t("disallow",e,this),t("ipRegex",e,this),t("appenders",e,this),t("onceOnly",e,this),this.seenRegexes=[],this},e.prototype.buildExceptionObject=function(e){var t={};return e.stack?t.stack=e.stack:t.e=e,e.message&&(t.message=e.message),e.name&&(t.name=e.name),e.data&&(t.data=e.data),e.inner&&(t.inner=this.buildExceptionObject(e.inner)),t},e.prototype.log=function(e,t,o){var a,u,h=0;if(!this.appenders)return this;if(e>=this.level&&n(this)&&(o?(u=this.buildExceptionObject(o)).logData=i(t):u=t,r(this,(a=s(u)).finalString))){if(this.onceOnly)for(h=this.onceOnly.length-1;h>=0;){if(new RegExp(this.onceOnly[h]).test(a.finalString)){if(this.seenRegexes[h])return this;this.seenRegexes[h]=!0}h--}for(a.meta=a.meta||{},h=this.appenders.length-1;h>=0;)this.appenders[h].log(d(e),a.msg,a.meta,function(){},e,a.finalString,this.loggerName),h--}return this},e.prototype.trace=function(e){return this.log(1e3,e)},e.prototype.debug=function(e){return this.log(2e3,e)},e.prototype.info=function(e){return this.log(3e3,e)},e.prototype.warn=function(e){return this.log(4e3,e)},e.prototype.error=function(e){return this.log(5e3,e)},e.prototype.fatal=function(e){return this.log(6e3,e)},e.prototype.fatalException=function(e,t){return this.log(6e3,e,t)},e}();e.Logger=S,e.createAjaxAppender=function(e){return new x(e)},e.createConsoleAppender=function(e){return new L(e)},w="undefined"!=typeof window?new x(""):new L(""),e.__=new e.Logger(""),e.__.setOptions({level:e.getDebugLevel(),appenders:[w]})}(JL||(JL={})),"undefined"!=typeof exports&&(exports.__esModule=!0,exports.JL=JL),"function"==typeof define&&define.amd&&define("jsnlog",[],function(){return JL}),"function"==typeof __jsnlog_configure&&__jsnlog_configure(JL),"undefined"==typeof window||window.onerror||(window.onerror=function(e,t,n,r,i){return JL("onerrorLogger").fatalException({msg:"Uncaught Exception",errorMsg:e?e.message||e:"",url:t,"line number":n,column:r},i),!1}),"undefined"==typeof window||window.onunhandledrejection||(window.onunhandledrejection=function(e){JL("onerrorLogger").fatalException({msg:"unhandledrejection",errorMsg:e.reason?e.reason.message:e.message||null},e.reason)});